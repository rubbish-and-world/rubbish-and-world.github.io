<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Ch7 | rubbishbin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="MathJax.Hub.Config({ tex2jax: {inlineMath: [[&#39;$&#39;, &#39;$&#39;]]}, messageStyle: &quot;none&quot; });  Chapter 7 Linking">
<meta property="og:type" content="article">
<meta property="og:title" content="Ch7">
<meta property="og:url" content="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/index.html">
<meta property="og:site_name" content="rubbishbin">
<meta property="og:description" content="MathJax.Hub.Config({ tex2jax: {inlineMath: [[&#39;$&#39;, &#39;$&#39;]]}, messageStyle: &quot;none&quot; });  Chapter 7 Linking">
<meta property="og:locale">
<meta property="og:image" content="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/slink.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/elfformat.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/linkstaticlib.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/elfstruct.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/pht.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/runtimeimg.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/dlink.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/got.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/gotandplt.png">
<meta property="article:published_time" content="2021-09-19T09:24:12.000Z">
<meta property="article:modified_time" content="2021-09-24T08:36:35.780Z">
<meta property="article:author" content="rubbish">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/slink.png">
  
    <link rel="alternate" href="/atom.xml" title="rubbishbin" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">rubbishbin</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://rubbish-and-world.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-CSAPP/Ch7" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/09/19/CSAPP/Ch7/" class="article-date">
  <time class="dt-published" datetime="2021-09-19T09:24:12.000Z" itemprop="datePublished">2021-09-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/csapp/">csapp</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Ch7
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: {inlineMath: [['$', '$']]}, messageStyle: "none" });</script>

<h1 id="Chapter-7-Linking"><a href="#Chapter-7-Linking" class="headerlink" title="Chapter 7 Linking"></a>Chapter 7 Linking</h1><a id="more"></a>

<p><em>Linking is the process of collecting and <strong>combining various pieces of code and data into a single file</strong> that can be loaded (copied) into memory and executed.</em></p>
<p>Linking can be performed</p>
<ul>
<li>At <strong>compile time</strong>, when the source code is translated into machine code</li>
<li>At <strong>load time</strong>, when the program is loaded into memory and executed by the loader</li>
<li>At <strong>run time</strong>, by application programs</li>
</ul>
<p>Linkers play a crucial role in software development because they enable <strong>separate compilation</strong>. We can saperate a hugh software into different modules. When we change one of these modules, we simply recompile it and relink the application, without having to recompile the other files.</p>
<h5 id="Why-bother-learning-about-linking"><a href="#Why-bother-learning-about-linking" class="headerlink" title="Why bother learning about linking?"></a>Why bother learning about linking?</h5><ul>
<li>Understanding linkers will help you build large programs</li>
<li>Understanding linkers will help you avoid dangerous programming errors</li>
<li>Understanding linking will help you understand how language scoping rules are implemented.</li>
<li>Understanding linking will help you understand other important systems concepts</li>
<li>Understanding linking will enable you to exploit shared libraries</li>
</ul>
<p>This chapter provides a thorough discussion of all aspects of linking, from traditional static linking, to dynamic linking of shared libraries at load time, to dynamic linking of shared libraries at run time.</p>
<h2 id="7-1-Compiler-Drivers"><a href="#7-1-Compiler-Drivers" class="headerlink" title="7.1 Compiler Drivers"></a>7.1 Compiler Drivers</h2><p><em>Most compilation systems provide a <strong>compiler driver</strong> that invokes the <strong>language preprocessor, compiler, assembler, and linker</strong>, as needed on behalf of the user</em></p>
<p>Let’s look at a concrete example</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source of main.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> *a, <span class="keyword">int</span> n)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">2</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> val = sum(<span class="built_in">array</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source of sum.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> *a, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i, s = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">s += a[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To compile these two C source file into a executable file, we will simply use gcc like this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -Og -o program main.c sum.c</span><br><span class="line">$ file program</span><br><span class="line">program: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="keyword">for</span> GNU/Linux 3.2.0, BuildID[sha1]=dd27fca66b73407650207acb585c98bb58ea4ed2, not stripped</span><br></pre></td></tr></table></figure>
<p>In fact a lot of things happened silently, let’s dig deeper</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -Og -o program main.c sum.c --verbose 2&gt;compilelog</span><br><span class="line">$ less compilelog</span><br></pre></td></tr></table></figure>
<p><img src="/2021/09/19/CSAPP/Ch7/slink.png" alt="static link"></p>
<p>(In some version of gcc, the <code>cpp</code> is integrated into the compile driver)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/lib/gcc/x86_64-linux-gnu/7/cc1 -quiet -v -imultiarch x86_64-linux-gnu main.c -quiet -dumpbase main.c     -mtune=generic -march=x86-64 -auxbase main -Og -version -fstack-protector-strong -Wformat -Wformat-security -o /tmp/cc4yMXEf.s</span><br><span class="line"><span class="comment"># compile main.c to /tmp/cc4yMXEf.s</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ as -v --64 -o /tmp/ccJm9qgp.o /tmp/cc4yMXEf.s</span><br><span class="line"><span class="comment"># assemble /tmp/cc4yMXEf.s to /tmp/ccJm9qgp.o</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/lib/gcc/x86_64-linux-gnu/7/cc1 -quiet -v -imultiarch x86_64-linux-gnu sum.c -quiet -dumpbase sum.c -mtune=generic -march=x86-64 -auxbase sum -Og -version -fstack-protector-strong -Wformat -Wformat-security  -o /tmp/cc4yMXEf.s</span><br><span class="line"><span class="comment"># compile sum.c to /tmp/cc4yMXEf.s</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$  as -v --64 -o /tmp/ccCtbZSy.o /tmp/cc4yMXEf.s</span><br><span class="line"><span class="comment"># assemble /tmp/cc4yMXEf.s to /tmp/ccCtbZSy.o</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/lib/gcc/x86_64-linux-gnu/7/collect2 </span><br><span class="line">-plugin /usr/lib/gcc/x86_64-linux-gnu/7/liblto_plugin.so </span><br><span class="line">-plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/7/lto-wrapper </span><br><span class="line">-plugin-opt=-fresolution=/tmp/ccFLjPvI.res </span><br><span class="line">-plugin-opt=-pass-through=-lgcc </span><br><span class="line">-plugin-opt=-pass-through=-lgcc_s </span><br><span class="line">-plugin-opt=-pass-through=-lc </span><br><span class="line">-plugin-opt=-pass-through=-lgcc </span><br><span class="line">-plugin-opt=-pass-through=-lgcc_s </span><br><span class="line">--build-id </span><br><span class="line">--eh-frame-hdr </span><br><span class="line">-m elf_x86_64 </span><br><span class="line">--hash-style=gnu </span><br><span class="line">--as-needed </span><br><span class="line">-dynamic-linker /lib64/ld-linux-x86-64.so.2 </span><br><span class="line">-pie </span><br><span class="line">-z now </span><br><span class="line">-z relro </span><br><span class="line">-o program </span><br><span class="line">/usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/Scrt1.o </span><br><span class="line">/usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/crti.o </span><br><span class="line">/usr/lib/gcc/x86_64-linux-gnu/7/crtbeginS.o </span><br><span class="line">-L/usr/lib/gcc/x86_64-linux-gnu/7 </span><br><span class="line">-L/usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu </span><br><span class="line">-L/usr/lib/gcc/x86_64-linux-gnu/7/../../../../lib </span><br><span class="line">-L/lib/x86_64-linux-gnu </span><br><span class="line">-L/lib/../lib </span><br><span class="line">-L/usr/lib/x86_64-linux-gnu </span><br><span class="line">-L/usr/lib/../lib </span><br><span class="line">-L/usr/lib/gcc/x86_64-linux-gnu/7/../../.. </span><br><span class="line">/tmp/ccJm9qgp.o </span><br><span class="line">/tmp/ccCtbZSy.o </span><br><span class="line">-lgcc </span><br><span class="line">--push-state </span><br><span class="line">--as-needed </span><br><span class="line">-lgcc_s </span><br><span class="line">--pop-state </span><br><span class="line">-lc </span><br><span class="line">-lgcc </span><br><span class="line">--push-state </span><br><span class="line">--as-needed </span><br><span class="line">-lgcc_s </span><br><span class="line">--pop-state </span><br><span class="line">/usr/lib/gcc/x86_64-linux-gnu/7/crtendS.o </span><br><span class="line">/usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/crtn.o</span><br><span class="line"><span class="comment"># link all the stuff</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/12584243/lets-analyse-collect2-ld-returned-1-exit-status">collect2 error</a></p>
<p><a target="_blank" rel="noopener" href="http://gcc.gnu.org/onlinedocs/gccint/Collect2.html">what is collect2</a></p>
<h2 id="7-2-Static-Linking"><a href="#7-2-Static-Linking" class="headerlink" title="7.2 Static Linking"></a>7.2 Static Linking</h2><p><em>Static linkers such as the Linux <code>ld</code> program take as input <strong>a collection of relocatable object files and command-line arguments</strong> and generate as output a <strong>fully linked executable object file</strong> that can be loaded and run.</em></p>
<p>To build the executable, the linker must perform two main tasks:</p>
<ol>
<li><p>Symbol resolution</p>
<p>Object files define and reference symbols, where each symbol corresponds to a function, a global variable, or a static variable.</p>
<p>The purpose of symbol resolution is to associate each symbol reference with exactly one symbol definition</p>
</li>
<li><p>Relocation</p>
<p>Compilers and assemblers generate code and data sections that start at address 0</p>
<p> The linker relocates these sections by <strong>associating a memory location with each symbol definition,</strong> and then <strong>modifying all of the references to those symbols so that they point to this memory location.</strong></p>
<p>The linker blindly performs these relocations using detailed instructions, generated by the assembler, called <em>relocation entries</em>.</p>
</li>
</ol>
<h2 id="7-3-Object-Files"><a href="#7-3-Object-Files" class="headerlink" title="7.3 Object Files"></a>7.3 Object Files</h2><p>Object files come in three forms:</p>
<ul>
<li><p>Relocatable object file. </p>
<p>Contains binary code and data in a form that <strong>can be combined with other relocatable object files at compile time</strong> to create an executable object file.</p>
</li>
<li><p>Executable object file</p>
<p>Contains binary code and data in a form that can be copied directly into memory and executed</p>
</li>
<li><p>Shared object file</p>
<p>A special type of relocatable object file that can <strong><em>be loaded into memory</em></strong> and <strong>linked dynamically</strong>, at either load time or run time</p>
</li>
</ul>
<p>Compilers and assemblers generate relocatable object files</p>
<p>Linkers generate executable object files. </p>
<p>Object files are organized according to specific <strong><em>object file formats</em></strong>, which vary from system to system.</p>
<ul>
<li> The first Unix systems from Bell Labs used the <code>a.out</code> format. </li>
<li>Windows uses the Portable Executable <code>PE</code> format</li>
<li>Mac OS-X uses the <code>Mach-O</code> format.</li>
<li>Modern x86-64 Linux and Unix systems use Executable and Linkable Format <code>ELF</code>.</li>
</ul>
<h2 id="7-4-Relocatable-Object-Files"><a href="#7-4-Relocatable-Object-Files" class="headerlink" title="7.4 Relocatable Object Files"></a>7.4 Relocatable Object Files</h2><p><img src="/2021/09/19/CSAPP/Ch7/elfformat.png" alt="elf format"></p>
<ul>
<li><p>The ELF header begins with a 16-byte sequence that describes the word size and byte ordering of the system that generated the file</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -h stand for --file-header</span></span><br><span class="line">$ readelf -h sum.o</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2<span class="string">&#x27;s complement, little endian</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              REL (Relocatable file)</span></span><br><span class="line"><span class="string">  Machine:                           Advanced Micro Devices X86-64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x0</span></span><br><span class="line"><span class="string">  Start of program headers:          0 (bytes into file)</span></span><br><span class="line"><span class="string">  Start of section headers:          528 (bytes into file)</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes)</span></span><br><span class="line"><span class="string">  Size of program headers:           0 (bytes)</span></span><br><span class="line"><span class="string">  Number of program headers:         0</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes)</span></span><br><span class="line"><span class="string">  Number of section headers:         11</span></span><br><span class="line"><span class="string">  Section header string table index: 10</span></span><br></pre></td></tr></table></figure>
<p>The rest of the ELF header contains information that allows a linker to parse and interpret the object file.</p>
<ul>
<li> size of the ELF header</li>
<li>the object file type (e.g., relocatable, executable, or shared)</li>
<li> the machine type (e.g., x86-64)</li>
<li>….</li>
</ul>
</li>
<li><p>The locations and sizes of the various sections are described by the <code>section header table</code>, which contains a fixed-size entry for each section in the object file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -S stand for --section-headers</span></span><br><span class="line">$ readelf -S sum.o</span><br><span class="line">There are 11 section headers, starting at offset 0x210:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       000000000000001b  0000000000000000  AX       0     0     1</span><br><span class="line">  [ 2] .data             PROGBITS         0000000000000000  0000005b</span><br><span class="line">       0000000000000000  0000000000000000  WA       0     0     1</span><br><span class="line">  [ 3] .bss              NOBITS           0000000000000000  0000005b</span><br><span class="line">       0000000000000000  0000000000000000  WA       0     0     1</span><br><span class="line">  [ 4] .comment          PROGBITS         0000000000000000  0000005b</span><br><span class="line">       000000000000002a  0000000000000001  MS       0     0     1</span><br><span class="line">  [ 5] .note.GNU-stack   PROGBITS         0000000000000000  00000085</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [ 6] .eh_frame         PROGBITS         0000000000000000  00000088</span><br><span class="line">       0000000000000030  0000000000000000   A       0     0     8</span><br><span class="line">  [ 7] .rela.eh_frame    RELA             0000000000000000  000001a0</span><br><span class="line">       0000000000000018  0000000000000018   I       8     6     8</span><br><span class="line">  [ 8] .symtab           SYMTAB           0000000000000000  000000b8</span><br><span class="line">       00000000000000d8  0000000000000018           9     8     8</span><br><span class="line">  [ 9] .strtab           STRTAB           0000000000000000  00000190</span><br><span class="line">       000000000000000b  0000000000000000           0     0     1</span><br><span class="line">  [10] .shstrtab         STRTAB           0000000000000000  000001b8</span><br><span class="line">       0000000000000054  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure></li>
<li><p>A typical ELF relocatable object file contains the following sections:</p>
<ul>
<li><p><code>.text</code> The machine code of the compiled program.</p>
</li>
<li><p><code>.rodata</code> Read-only data such as the format strings in printf statements, and jump tables for switch statements.</p>
</li>
<li><p><code>.data</code> <strong><em>==Initialized== global and static</em></strong> C variables. Local C variables are maintained at run time on the stack and do not appear in either the <code>.data </code>or <code>.bss</code> sections.</p>
</li>
<li><p><code>.bss</code> <strong><em>Uninitialized global and static</em></strong> C variables, along with any global or static variables that are <strong><em>initialized to zero</em></strong></p>
<p>This section occupies no actual space in the object file, uninitialized variables do not have to occupy any actual disk space in the object file. At run time, these variables are allocated in memory with an initial value of zero.</p>
</li>
<li><p><code>.symtab</code> A symbol table with information about <strong>functions, static local variables and global variables</strong>(NO nonstatic local variables) that are defined and referenced in the program. </p>
<p>Every relocatable object file has a symbol table in <code>.symtab</code>, unless the programmer has specifically removed it with the <code>strip</code> command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -s stand for --symbols</span></span><br><span class="line">$ readelf -s sum.o</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains 9 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS sum.c</span><br><span class="line">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 </span><br><span class="line">     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    2 </span><br><span class="line">     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 </span><br><span class="line">     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 </span><br><span class="line">     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    6 </span><br><span class="line">     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 </span><br><span class="line">     8: 0000000000000000    27 FUNC    GLOBAL DEFAULT    1 sum</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -R stand for remove</span></span><br><span class="line">$ strip -R symtab  -o stripped_sum.o sum.o</span><br><span class="line">$ readelf -s stripped_sum.o</span><br><span class="line">$ readelf -S stripped_sum.o</span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       000000000000001b  0000000000000000  AX       0     0     1</span><br><span class="line">  [ 2] .data             PROGBITS         0000000000000000  0000005b</span><br><span class="line">       0000000000000000  0000000000000000  WA       0     0     1</span><br><span class="line">  [ 3] .bss              NOBITS           0000000000000000  0000005b</span><br><span class="line">       0000000000000000  0000000000000000  WA       0     0     1</span><br><span class="line">  [ 4] .comment          PROGBITS         0000000000000000  0000005b</span><br><span class="line">       000000000000002a  0000000000000001  MS       0     0     1</span><br><span class="line">  [ 5] .note.GNU-stack   PROGBITS         0000000000000000  00000085</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [ 6] .eh_frame         PROGBITS         0000000000000000  00000088</span><br><span class="line">       0000000000000030  0000000000000000   A       0     0     8</span><br><span class="line">  [ 7] .shstrtab         STRTAB           0000000000000000  000000b8</span><br><span class="line">       000000000000003f  0000000000000000           0     0     1</span><br></pre></td></tr></table></figure></li>
<li><p><code>.rel.text</code> <strong>A list of locations</strong> in the <code>.text</code> section that will need to be modified when the linker combines this object file with others.</p>
<p>In general, any instruction that <strong>calls an external function or references a global variable</strong> will need to be modified. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -r stand for --relocs</span></span><br><span class="line">$ readelf -r sum.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rela.eh_frame&#x27;</span> at offset 0x1a0 contains 1 entry:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0</span><br></pre></td></tr></table></figure></li>
<li><p><code>.rel.data</code> Relocation information for any <strong>global variables</strong> that are referenced or defined by the module. In general, any initialized global variable whose initial value is the address of a global variable or externally defined function will need to be modified.</p>
</li>
<li><p><code>.debug</code> A debugging symbol table with entries for local variables and typedefs defined in the program, global variables defined and referenced in the program, and the original C source file. </p>
<p><code>.line</code>A mapping between line numbers in the original C source program and machine code instructions in the <code>.text</code> section</p>
<p><strong>They are only present if the compiler driver is invoked with the <code>-g</code> option.</strong></p>
</li>
<li><p><code>.strtab</code>This section holds strings, most commonly the strings that represent the names associated with symbol table entries. A string table is <strong>a sequence of null-terminated character strings</strong>.</p>
</li>
</ul>
</li>
</ul>
<p>If you want to know more about <code>ELF</code> : <code>man elf</code></p>
<blockquote>
<p>The use of the term <code>.bss</code> to denote uninitialized data is universal. It was originally an acronym for the “block started by symbol” directive from the IBM 704 assembly language (circa 1957) and the acronym has stuck. A simple way to remember the difference between the .data and .bss sections is to think of “bss” as an abbreviation for “Better Save Space!”</p>
</blockquote>
<h2 id="7-5-Symbols-and-Symbol-Tables"><a href="#7-5-Symbols-and-Symbol-Tables" class="headerlink" title="7.5 Symbols and Symbol Tables"></a>7.5 Symbols and Symbol Tables</h2><p><em>Each relocatable object module, m, has a symbol table that contains information about the <strong>symbols that are defined and referenced by m</strong>.</em></p>
<p>In the context of a linker, there are three different kinds of symbols:</p>
<ul>
<li><p><strong>Global symbols that are defined by module m</strong> and that can be referenced by other modules. </p>
<p>Global linker symbols correspond to nonstatic C functions and global variables</p>
</li>
<li><p><strong>Global symbols that are referenced by module m</strong> but defined by some other module. </p>
<p>Such symbols are called externals and correspond to nonstatic C functions and global variables that are defined in other modules.</p>
</li>
<li><p><strong>Local symbolsthat are defined and referenced exclusively by module m</strong>. These correspond to static C functions and global variables that are defined with the static attribute. These symbols are visible anywhere within module m, but cannot be referenced by other modules.</p>
</li>
</ul>
<p>For example</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source of fun.c</span></span><br><span class="line"><span class="keyword">int</span> globalvariable = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> x = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> staticlocal = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> nonstaticlocalinf = <span class="number">50</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">g</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> x = <span class="number">90</span>;</span><br><span class="line">    <span class="keyword">int</span> nonstaticlocaling = <span class="number">40</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -s fun.o</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains 14 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS fun.c</span><br><span class="line">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 </span><br><span class="line">     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    2 </span><br><span class="line">     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 </span><br><span class="line">     5: 0000000000000004     4 OBJECT  LOCAL  DEFAULT    2 staticlocal.1796</span><br><span class="line">     6: 0000000000000008     4 OBJECT  LOCAL  DEFAULT    2 x.1795</span><br><span class="line">     7: 000000000000000c     4 OBJECT  LOCAL  DEFAULT    2 x.1800</span><br><span class="line">     8: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 </span><br><span class="line">     9: 0000000000000000     0 SECTION LOCAL  DEFAULT    6 </span><br><span class="line">    10: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 </span><br><span class="line">    11: 0000000000000000     4 OBJECT  GLOBAL DEFAULT    2 globalvariable</span><br><span class="line">    12: 0000000000000000    14 FUNC    GLOBAL DEFAULT    1 f</span><br><span class="line">    13: 000000000000000e    14 FUNC    GLOBAL DEFAULT    1 g</span><br></pre></td></tr></table></figure>
<p>Notice that each <code>static</code> variable is given a unique name, such as <code>x.1795</code> and <code>x.1800</code>, they are different variables!</p>
<blockquote>
<p>C programmers use the <code>static</code> attribute to hide variable and function declarations inside modules, much as you would use <code>public</code> and <code>private</code> declarations in Java and C++. In C, source files play the role of modules. Any global variable or function declared with the static attribute is private to that module. Similarly, any global variable or function declared without the static attribute is public and can be accessed by any other module. It is good programming practice to protect your variables and functions with the static attribute wherever possible.</p>
</blockquote>
<hr>
<p>An ELF symbol table is contained in the <code>.symtab</code> section. It contains an array of entries</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> name; <span class="comment">/* String table offset */</span></span><br><span class="line"><span class="keyword">char</span> type:<span class="number">4</span>, <span class="comment">/* Function or data (4 bits) */</span></span><br><span class="line">binding:<span class="number">4</span>; <span class="comment">/* Local or global (4 bits) */</span></span><br><span class="line"><span class="keyword">char</span> reserved; <span class="comment">/* Unused */</span></span><br><span class="line"><span class="keyword">short</span> section; <span class="comment">/* Section header index */</span></span><br><span class="line"><span class="keyword">long</span> value; <span class="comment">/* Section offset or absolute address, the run-time address for every reference */</span></span><br><span class="line"><span class="keyword">long</span> size; <span class="comment">/* Object size in bytes */</span></span><br><span class="line">&#125; Elf64_Symbol;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>The <code>name</code> is a <strong>byte offset into the string table</strong> that points to the null-terminated string name of the symbol. </p>
<p>(For relocatable modules, the value is an <strong>offset</strong> from the beginning of the section where the object is defined. )</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -p .strtab fun.o</span><br><span class="line"></span><br><span class="line">String dump of section <span class="string">&#x27;.strtab&#x27;</span>:</span><br><span class="line">  [     1]  fun.c</span><br><span class="line">  [     7]  staticlocal.1796</span><br><span class="line">  [    18]  x.1795</span><br><span class="line">  [    1f]  x.1800</span><br><span class="line">  [    26]  globalvariable</span><br><span class="line">  [    35]  f</span><br><span class="line">  [    37]  g</span><br><span class="line">$ readelf -x .symtab fun.o</span><br><span class="line">.....</span><br><span class="line">0x00000130 0e000000 00000000 37000000 12000100 </span><br><span class="line">0x00000140 0e000000 00000000 0e000000 00000000 </span><br><span class="line">.....</span><br><span class="line"><span class="comment"># beware that data is in little-endian mode</span></span><br><span class="line"><span class="comment"># int name = 0x00000037; (g)</span></span><br><span class="line"><span class="comment"># char typebinding = 0b00010010; (FUNC GLOBAL)</span></span><br><span class="line"><span class="comment"># char reserved = 0x00;</span></span><br><span class="line"><span class="comment"># short section = 0x0001; (in .text section)</span></span><br><span class="line"><span class="comment"># long value = 0x000000000000000e; (000000000000000e)</span></span><br><span class="line"><span class="comment"># long value = 0x000000000000000e; (14 bytes)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>Each symbol is assigned to some section of the object file, denoted by the section field, which is an index into the section header table</p>
<p>There are three <strong>special pseudosections</strong> that don’t have entries in the section header table: </p>
<ul>
<li><code>ABS</code>(absolute) is for symbols that should not be relocated. </li>
<li><code>UNDEF</code> is for undefined symbols—that is, symbols that are <strong>referenced in this object module but defined elsewhere.</strong> </li>
<li><code>COMMON</code> is for uninitialized data objects that are not yet allocated</li>
</ul>
<p>For <code>COMMON</code> symbols, the value field gives the alignment requirement, and size gives the minimum size. </p>
<p>Note that these pseudosections <strong>exist only in relocatable object files</strong>; they do not exist in executable object files.</p>
<p>The distinction between <code>COMMON</code> and <code>.bss</code> is subtle. Modern versions of gcc assign symbols in relocatable object files to <code>COMMON</code> and <code>.bss</code> using the following <strong><em>convention</em></strong>:</p>
<ul>
<li><code>COMMON</code> Uninitialized global variables</li>
<li><code>.bss</code> <strong>Uninitialized static variables</strong> and <strong>global or static variables that are initialized to zero</strong></li>
</ul>
<p>The distinction stems from the way the linker performs symbol resolution</p>
<h4 id="Practice-Problem-7-1"><a href="#Practice-Problem-7-1" class="headerlink" title="Practice Problem 7.1"></a>Practice Problem 7.1</h4><blockquote>
<p>This problem concerns the <code>m.o</code> and <code>swap.o</code> modules from the following code.</p>
<p> For each symbol that is defined or referenced in <code>swap.o</code>, indicate whether or not it will have a symbol table entry in the <code>.symtab</code> section in module <code>swap.o</code>.</p>
<p> If so, indicate the module that defines the symbol (swap.o or m.o), the symbol type (local, global, or extern), and the section (.text, .data, .bss, or COMMON) it is assigned to in the module.</p>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>.symtab entry?</th>
<th>Symbol type</th>
<th>Module  where defined</th>
<th>Section</th>
</tr>
</thead>
<tbody><tr>
<td>Buf</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bufp0</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bufp1</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>swap</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>temp</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source of swap.c</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> buf[];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> *bufp0 = &amp;buf[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">int</span> *bufp1;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> temp;</span><br><span class="line"></span><br><span class="line"> bufp1 = &amp;buf[<span class="number">1</span>];</span><br><span class="line"> temp = *bufp0;</span><br><span class="line"> *bufp0 = *bufp1;</span><br><span class="line"> *bufp1 = temp;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source of m.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> buf[<span class="number">2</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">swap();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="My-solution-white-check-mark"><a href="#My-solution-white-check-mark" class="headerlink" title="My solution : :white_check_mark:"></a>My solution : :white_check_mark:</h4><table>
<thead>
<tr>
<th>Symbol</th>
<th>.symtab entry?</th>
<th>Symbol type</th>
<th>Module  where defined</th>
<th>Section</th>
</tr>
</thead>
<tbody><tr>
<td>Buf</td>
<td>YES</td>
<td>Extern</td>
<td>m.o</td>
<td>UNDEF</td>
</tr>
<tr>
<td>Bufp0</td>
<td>YES</td>
<td>Global</td>
<td>swap.o</td>
<td>.data</td>
</tr>
<tr>
<td>bufp1</td>
<td>YES</td>
<td>Global</td>
<td>swap.o</td>
<td>COMMON</td>
</tr>
<tr>
<td>swap</td>
<td>YES</td>
<td>Global</td>
<td>swap.o</td>
<td>.text</td>
</tr>
<tr>
<td>temp</td>
<td>NO</td>
<td>local</td>
<td>swap.o</td>
<td>NO</td>
</tr>
</tbody></table>
<h4 id="Verification"><a href="#Verification" class="headerlink" title="Verification:"></a>Verification:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -s swap.o</span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains 13 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     9: 0000000000000000     8 OBJECT  GLOBAL DEFAULT    5 bufp0</span><br><span class="line">    10: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND buf</span><br><span class="line">    11: 0000000000000008     8 OBJECT  GLOBAL DEFAULT  COM bufp1</span><br><span class="line">    12: 0000000000000000    63 FUNC    GLOBAL DEFAULT    1 swap</span><br></pre></td></tr></table></figure>
<h2 id="7-6-Symbol-Resolution"><a href="#7-6-Symbol-Resolution" class="headerlink" title="7.6 Symbol Resolution"></a>7.6 Symbol Resolution</h2><p><em>The linker resolves symbol references by <strong>associating each reference with exactly one symbol definition</strong> from the symbol tables of its input relocatable object files</em></p>
<ul>
<li><p>The compiler allows only one definition of each local symbol per module. </p>
</li>
<li><p>The compiler also ensures that static local variables, which get local linker symbols, have unique names.(<code>x.1780</code> and <code>x.1775</code>, for example)</p>
</li>
<li><p>When the compiler encounters a <strong>symbol</strong> (either a variable or function name) that is <strong>not defined in the current module</strong>, it assumes that it is defined in some other module, generates a linker symbol table entry, and <strong>leaves it for the linker to handle.</strong></p>
<p>If the linker is unable to find a definition for the referenced symbol in any of its input modules, it prints an error message and terminates</p>
<p>For instance</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fun();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -o error error.c </span><br><span class="line">/tmp/cc10TnoD.o: In <span class="keyword">function</span> `main<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">error.c:(.text+0x5): undefined reference to `fun&#x27;</span></span><br><span class="line">collect2: error: ld returned 1 <span class="built_in">exit</span> status</span><br></pre></td></tr></table></figure></li>
<li><p>Multiple object modules might define global symbols with the same name, the linker must report an error or choose one as the definition and discard the rest.</p>
</li>
</ul>
<h3 id="7-6-1-How-Linkers-Resolve-Duplicate-Symbol-Names"><a href="#7-6-1-How-Linkers-Resolve-Duplicate-Symbol-Names" class="headerlink" title="7.6.1 How Linkers Resolve Duplicate Symbol Names"></a>7.6.1 How Linkers Resolve Duplicate Symbol Names</h3><p><em>Here is the approach that Linux compilation systems use.</em></p>
<ul>
<li><p>At compile time, the compiler exports each global symbol to the assembler as either <code>strong</code> or <code>weak</code>, and the assembler encodes this information implicitly in the symbol table of the relocatable object file.</p>
<p>Functions and initialized global variables get strong symbols. Uninitialized global variables get weak symbols.</p>
</li>
<li><p>Linux linkers use the following rules for dealing with duplicate symbol names:</p>
<ul>
<li>Rule 1. Multiple strong symbols with the same name are not allowed</li>
<li>Rule 2. Given a strong symbol and multiple weak symbols with the same name, choose the strong symbol.</li>
<li>Rule 3. Given multiple weak symbols with the same name, <strong>choose any of the weak symbols.</strong>(Can be viewed as an undefined behavior!!!)</li>
</ul>
</li>
<li><p>Tons of bugs can happen when using global variables between different modules, that is why someone say that it is a bad idea to use global variables, be careful when you using it!!! Compile with the following parameters</p>
<ul>
<li><code>-fno-common</code> : report error if encounters multiply defined global symbols</li>
<li><code>-Werror</code> : turns all warnings into errors.</li>
<li><code>-Wall</code> : enables all the warnings</li>
</ul>
</li>
</ul>
<p>And this is the reason for <code>COMMON</code> and <code>.bss</code> section</p>
<ul>
<li>When compiler encounters a <code>static</code> local symbol, it can confidently say that it is the definition.</li>
<li>When the compiler encounters global symbos which is initialized to 0, it can say that it is a strong symbol and put it in <code>.bss</code></li>
<li>Only when the compiler encounters an uninitialized global symbol, it can’t guarantee that it is a definition, since it is a weak symbol, so put it in <code>COMMON</code></li>
</ul>
<h4 id="Practice-Problem-7-2"><a href="#Practice-Problem-7-2" class="headerlink" title="Practice Problem 7.2"></a>Practice Problem 7.2</h4><blockquote>
<p>In this problem, let <code>REF(x.i) -&gt; DEF(x.k)</code> denote that the linker will associate an arbitrary reference to symbol x in module i to the definition of x in module k. </p>
<p>For each example that follows, use this notation to indicate how the linker would resolve references to the multiply-defined symbol in each module. </p>
<p>If there is a link-time error (rule 1), write “error”. If the linker arbitrarily chooses one of the definitions (rule 3), write “unknown”.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//A</span></span><br><span class="line"><span class="comment">//Module 1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"><span class="comment">//Module 2</span></span><br><span class="line"><span class="keyword">int</span> main;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">p2</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">(a)REF(main.1) -&gt; DEF(______)</span></span><br><span class="line"><span class="comment">(b)REF(main.2) -&gt; DEF(______)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//B</span></span><br><span class="line"><span class="comment">//Module 1</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"><span class="comment">//Module 2</span></span><br><span class="line"><span class="keyword">int</span> main = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">p2</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">(a)REF(main.1) -&gt; DEF(_____)</span></span><br><span class="line"><span class="comment">(b)REF(main.2) -&gt; DEF(_____) </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//C</span></span><br><span class="line"><span class="comment">//Module 1</span></span><br><span class="line"><span class="keyword">int</span> x;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"><span class="comment">//Module 2</span></span><br><span class="line"><span class="keyword">double</span> x = <span class="number">1.0</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">p2</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">(a)REF(x.1) -&gt; DEF(_____)</span></span><br><span class="line"><span class="comment">(b)REF(x.2) -&gt; DEF(_____) </span></span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="My-solution-white-check-mark-1"><a href="#My-solution-white-check-mark-1" class="headerlink" title="My solution : :white_check_mark:"></a>My solution : :white_check_mark:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">A:</span><br><span class="line">(a)REF(main.1) -&gt; DEF(main.1)</span><br><span class="line">(b)REF(main.2) -&gt; DEF(main.1)</span><br><span class="line">B:</span><br><span class="line">(a)REF(main.1) -&gt; DEF(ERROR)</span><br><span class="line">(b)REF(main.2) -&gt; DEF(ERROR)</span><br><span class="line">C:</span><br><span class="line">(a)REF(x.1) -&gt; DEF(x.2)</span><br><span class="line">(b)REF(x.2) -&gt; DEF(x.2)</span><br></pre></td></tr></table></figure>
<h3 id="7-6-2-Linking-with-Static-Libraries"><a href="#7-6-2-Linking-with-Static-Libraries" class="headerlink" title="7.6.2 Linking with Static Libraries"></a>7.6.2 Linking with Static Libraries</h3><p><em>In practice, all compilation systems provide a mechanism for packaging related object modules into a single file called a <strong>static library</strong>, which can then be supplied as input to the linker</em></p>
<p>When it builds the output executable, the linker <strong>copies</strong> only the object modules in the library that are <strong>referenced</strong> by the application program.</p>
<ul>
<li><p>Library functions can be compiled into <strong>separate object modules</strong> and then <strong>packaged in a single static library file</strong>.</p>
</li>
<li><p>Application programs can then use any of the functions defined in the library by <strong>specifying a single filename</strong> on the command line</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># program use C standard library</span></span><br><span class="line">$ gcc main.c /usr/lib/libc.a</span><br></pre></td></tr></table></figure></li>
<li><p>At link time, the linker will <strong>only copy the object modules that are referenced by the program</strong>, which reduces the size of the executable on disk and in memory.</p>
</li>
</ul>
<p>On Linux systems, static libraries are stored on disk in a particular file format known as an <code>archive</code>.</p>
<ul>
<li>An archive is a collection of concatenated relocatable object files, with a header that describes the size and location of each member object file. </li>
<li>Archive filenames are denoted with the <code>.a</code> suffix.</li>
</ul>
<p>Let’s make our own little static library for illustration</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source of addvec.c</span></span><br><span class="line"><span class="keyword">int</span> addcnt = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addvec</span><span class="params">(<span class="keyword">int</span> *x, <span class="keyword">int</span> *y,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> *z, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line">addcnt++;</span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line"> z[i] = x[i] + y[i];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source of mulvec.c</span></span><br><span class="line"><span class="keyword">int</span> multcnt = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">multvec</span><span class="params">(<span class="keyword">int</span> *x, <span class="keyword">int</span> *y,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> *z, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line">multcnt++;</span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line"> z[i] = x[i] * y[i];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -c addvec.c mulvec.c</span><br><span class="line">$ ar rcs libvec.a addvec.o mulvec.o </span><br><span class="line"><span class="comment"># rcs are all arguments for ar, see at `man ar`</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source of vector.h</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addvec</span><span class="params">(<span class="keyword">int</span> *x, <span class="keyword">int</span> *y, <span class="keyword">int</span> *z, <span class="keyword">int</span> n)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">multvec</span><span class="params">(<span class="keyword">int</span> *x, <span class="keyword">int</span> *y, <span class="keyword">int</span> *z, <span class="keyword">int</span> n)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source of main.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;vector.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> x[<span class="number">2</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> y[<span class="number">2</span>] = &#123;<span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> z[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> addvec(x, y, z, <span class="number">2</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;z = [%d %d]\n&quot;</span>, z[<span class="number">0</span>], z[<span class="number">1</span>]);</span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -c main.c</span><br><span class="line">$ gcc -o prog main.c -static -L. -lvec</span><br><span class="line">$ file prog</span><br><span class="line">prog: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, <span class="keyword">for</span> GNU/Linux 3.2.0, BuildID[sha1]=4def2b1996af12eace08bd1e58e7b08332933dc9, not stripped</span><br><span class="line">$ ./prog</span><br><span class="line">[4 6]</span><br><span class="line"><span class="comment"># -L specify the directory to look up the static library</span></span><br><span class="line"><span class="comment"># . means current directory</span></span><br><span class="line"><span class="comment"># -lvec is shorthand for libvec.a</span></span><br><span class="line"><span class="comment"># -lxxxxxx is short for libxxxxx.a</span></span><br><span class="line"><span class="comment"># libc.a is passed as default argument in gcc</span></span><br><span class="line"><span class="comment"># -static in manual :On systems that support dynamic linking, this prevents linking with the shared libraries.  On other systems, this option has no effect.</span></span><br><span class="line"><span class="comment"># statically linked means we have all instructions stored in our ELF file, no run-time linking needed.</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/09/19/CSAPP/Ch7/linkstaticlib.png" alt="link static library"></p>
<ul>
<li>The <code>-static</code> argument tells the compiler driver that the linker should build a fully linked executable object file that can be loaded into memory and <strong>run without any further linking at load time</strong></li>
<li>Since the program doesn’t reference any symbols defined by <code>mulvec.o</code>, the linker does not copy this module into the executable</li>
<li>The linker also copies the <code>printf.o</code> module from <code>libc.a</code>, <strong>along with a number of other modules from the C run-time system.</strong></li>
</ul>
<h3 id="7-6-3-How-Linkers-Use-Static-Libraries-to-Resolve-References"><a href="#7-6-3-How-Linkers-Use-Static-Libraries-to-Resolve-References" class="headerlink" title="7.6.3 How Linkers Use Static Libraries to Resolve References"></a>7.6.3 How Linkers Use Static Libraries to Resolve References</h3><p><em>During the symbol resolution phase, the linker scans the relocatable object files and archives left to right <strong>in the same sequential order that they appear on the compiler driver’s command line</strong>.</em></p>
<p>During this scan, the linker maintains </p>
<ul>
<li>a set E of relocatable object files that will be merged to form the executable, </li>
<li>a set U of unresolved symbols (i.e., symbols referred to but not yet defined), </li>
<li>a set D of symbols that have been defined in previous input files. </li>
<li>Initially, E, U, and D are empty.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># scan process</span></span><br><span class="line">E = []</span><br><span class="line">U = []</span><br><span class="line">D = []</span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> command_line_arguments:</span><br><span class="line">    <span class="keyword">if</span> file <span class="keyword">is</span> object_file:</span><br><span class="line">        E.append(file)</span><br><span class="line">        U.update(file.symbols)</span><br><span class="line">        D.update(file.symbols)</span><br><span class="line">    <span class="keyword">elif</span> file <span class="keyword">is</span> archive_file:</span><br><span class="line">        <span class="keyword">for</span> undefsym <span class="keyword">in</span> U:</span><br><span class="line">            <span class="keyword">for</span> m <span class="keyword">in</span> file:</span><br><span class="line">                <span class="keyword">if</span> m.defines(undefsym):</span><br><span class="line">                    E.append(m)</span><br><span class="line">                    U.update(m.symbols)</span><br><span class="line">                    D.update(m.symbols)</span><br><span class="line"><span class="keyword">if</span> U.empty() == <span class="literal">False</span>:</span><br><span class="line">    sys.stderr.write(error)</span><br><span class="line">    exit()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    build(E)</span><br></pre></td></tr></table></figure>
<p>This algorithm can result in some baffling link-time errors because the <strong>ordering of libraries and object files on the command line is significant</strong>.</p>
<ul>
<li><p>If the library that defines a symbol appears on the command line before the object file that references that symbol, then the reference will not be resolved and linking will fail(Library should always comes after object files)</p>
<p>For example</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -static -o prog ./libvec.a main.o </span><br><span class="line">main.o: In <span class="keyword">function</span> `main<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">main.c:(.text+0x1f): undefined reference to `addvec&#x27;</span></span><br><span class="line">collect2: error: ld returned 1 <span class="built_in">exit</span> status</span><br><span class="line"><span class="comment"># U is initialized to empty, so if libraries come first, no object in archive will be added to E.</span></span><br><span class="line"><span class="comment"># Then the `addevec` cannot be solved laterly</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>Libraries can be repeated</strong> on the command line if necessary to satisfy the dependence requirements.</p>
<p>(Object files do not need to be repeated since they are added to E immediately after appearance)</p>
</li>
</ul>
<h4 id="Practice-Problem-7-3"><a href="#Practice-Problem-7-3" class="headerlink" title="Practice Problem 7.3"></a>Practice Problem 7.3</h4><blockquote>
<p>Let <code>a</code> and <code>b</code> denote object modules or static libraries in the current directory, and let <code>a→b</code> denote that a depends on b, in the sense that b defines a symbol that is referenced by a.</p>
<p> For each of the following scenarios, show the minimal command line (i.e., one with the least number of object file and library arguments) that will allow the static linker to resolve all symbol references.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A. p.o → libx.a</span><br><span class="line">B. p.o → libx.a → liby.a</span><br><span class="line">C. p.o → libx.a → liby.a and liby.a → libx.a → p.o</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="My-solution-white-check-mark-2"><a href="#My-solution-white-check-mark-2" class="headerlink" title="My solution : :white_check_mark:"></a>My solution : :white_check_mark:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A</span></span><br><span class="line">$ gcc p.o ./libx.a</span><br><span class="line"><span class="comment"># B</span></span><br><span class="line">$ gcc p.o ./libx.a ./liby.a</span><br><span class="line"><span class="comment"># C</span></span><br><span class="line">$ gcc p.o ./libx.a ./liby.a ./libx.a</span><br></pre></td></tr></table></figure>
<h2 id="7-7-Relocation"><a href="#7-7-Relocation" class="headerlink" title="7.7 Relocation"></a>7.7 Relocation</h2><p><em>After symbol resolution, the linker knows the exact sizes of the code and data sections in its input object modules. It is now ready to begin the relocation step, where it <strong>merges the input modules and assigns run-time addresses to each symbol</strong></em></p>
<p>Relocation consists of two steps</p>
<ol>
<li>Relocating sections and symbol definitions</li>
</ol>
<ul>
<li>The linker <strong>merges all sections of the same type into a new aggregate section of the same type</strong></li>
<li>The linker then assigns run-time memory addresses to the new aggregate sections, to each section defined by the input modules, and to each symbol defined by the input modules</li>
</ul>
<ol start="2">
<li>Relocating symbol references within sections</li>
</ol>
<ul>
<li>the linker modifies every symbol reference in the bodies of the code and data sections so that they point to the correct run-time addresses. </li>
<li>To perform this step, the linker relies on data structures in the relocatable object modules known as relocation entries, which we describe next.</li>
</ul>
<h3 id="7-7-1-Relocation-Entries"><a href="#7-7-1-Relocation-Entries" class="headerlink" title="7.7.1 Relocation Entries"></a>7.7.1 Relocation Entries</h3><p><em>Whenever the assembler encounters a reference to an object whose ultimate location is unknown, it generates a <strong>relocation entry</strong> that <strong>tells the linker how to modify the reference when it merges the object file into an executable</strong></em></p>
<p>Relocation entries for code are placed in <code>.rel.text</code>. Relocation entries for data are placed in <code>.rel.data</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="keyword">long</span> offset; <span class="comment">/* Offset of the reference to relocate */</span></span><br><span class="line"><span class="keyword">long</span> type:<span class="number">32</span>, <span class="comment">/* Relocation type */</span></span><br><span class="line">symbol:<span class="number">32</span>; <span class="comment">/* Symbol table index */</span></span><br><span class="line"><span class="keyword">long</span> addend; <span class="comment">/* Constant part of relocation expression */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br><span class="line"><span class="comment">//ELF relocation entry. Each entry identifies a reference that must be relocated and specifies how to compute the modified reference.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -r main.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rela.text&#x27;</span> at offset 0x2c8 contains 8 entries:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">00000000000c  000b00000002 R_X86_64_PC32     0000000000000008 z - 4</span><br><span class="line">000000000013  000a00000002 R_X86_64_PC32     0000000000000008 y - 4</span><br><span class="line">00000000001a  000900000002 R_X86_64_PC32     0000000000000000 x - 4</span><br><span class="line">00000000001f  000e00000004 R_X86_64_PLT32    0000000000000000 addvec - 4</span><br><span class="line">000000000025  000b00000002 R_X86_64_PC32     0000000000000008 z + 0</span><br><span class="line">00000000002b  000b00000002 R_X86_64_PC32     0000000000000008 z - 4</span><br><span class="line">000000000034  000500000002 R_X86_64_PC32     0000000000000000 .rodata - 4</span><br><span class="line">00000000003e  000f00000004 R_X86_64_PLT32    0000000000000000 <span class="built_in">printf</span> - 4</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rela.eh_frame&#x27;</span> at offset 0x388 contains 1 entry:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0</span><br><span class="line">$ readelf -x .rela.text  main.o</span><br><span class="line">Hex dump of section <span class="string">&#x27;.rela.text&#x27;</span>:</span><br><span class="line">  0x00000000 0c000000 00000000 02000000 0b000000 </span><br><span class="line">  0x00000010 fcffffff ffffffff 13000000 00000000 </span><br></pre></td></tr></table></figure>
<ul>
<li>The <code>offset</code> is the section offset of the reference that will need to be modified. </li>
<li>The <code>symbol</code> identifies the symbol that the modified reference should point to.</li>
<li>The <code>type</code> tells the linker how to modify the new reference. </li>
<li>The <code>addend</code> is a signed constant that is used by some types of relocations to <strong>bias</strong> the value of the modified reference.</li>
</ul>
<p>ELF defines 32 different relocation types, we will see two of them</p>
<ul>
<li><code>R_X86_64_PC32</code><ul>
<li>Relocate a reference that uses a <strong>32-bit PC-relative address</strong></li>
</ul>
</li>
<li><code>R_X86_64_32</code><ul>
<li> Relocate a reference that uses a 32-bit <strong>absolute address</strong></li>
</ul>
</li>
</ul>
<h3 id="7-7-2-Relocating-Symbol-References"><a href="#7-7-2-Relocating-Symbol-References" class="headerlink" title="7.7.2 Relocating Symbol References"></a>7.7.2 Relocating Symbol References</h3><p>Relocation algorithm</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">foreach section s &#123;</span><br><span class="line">    foreach relocation entry r &#123;</span><br><span class="line">    refptr= s+ r.offset; <span class="comment">/* ptr to reference to be relocated */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Relocate a PC-relative reference */</span></span><br><span class="line">    <span class="comment">/* ADDR(s) means run-time address for section s */</span></span><br><span class="line">    <span class="comment">/* ADDR(r.symbol) means run-time address for r&#x27;s symbol(when it is referred, where acutally it is, the &#x27;real address&#x27;) */</span></span><br><span class="line">    <span class="keyword">if</span> (r.type == R_X86_64_PC32) &#123;</span><br><span class="line">        refaddr = ADDR(s) + r.offset; <span class="comment">/* ref’s run-time address */</span></span><br><span class="line">        *refptr = (<span class="keyword">unsigned</span>) (ADDR(r.symbol) + r.addend - refaddr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Relocate an absolute reference */</span></span><br><span class="line">     <span class="keyword">if</span> (r.type == R_X86_64_32)</span><br><span class="line">     *refptr = (<span class="keyword">unsigned</span>) (ADDR(r.symbol) + r.addend);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Relocating-PC-Relative-References"><a href="#Relocating-PC-Relative-References" class="headerlink" title="Relocating PC-Relative References"></a>Relocating PC-Relative References</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># sum here is a reference</span><br><span class="line">e: e8 00 00 00 00 		callq 13 &lt;main+0x13&gt; sum()</span><br><span class="line">		f: R_X86_64_PC32 sum-0x4 Relocation entry	</span><br></pre></td></tr></table></figure>
<p>The assembler will generate a relocate entry for <code>sum</code> in <code>.rela.text</code> section</p>
<p>Later the when the linker executing the relocation algorithm:</p>
<ol>
<li>Calculate the address of <code>sum</code> in symbol table</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">refptr = s + r.offset;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>Modify it using PC relative principle</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*refptr = (<span class="keyword">unsigned</span>) (ADDR(r.symbol) + r.addend - refaddr);</span><br><span class="line"><span class="comment">//PC_rela_address = target address + bias - run_time_refer_addr</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>The symbol’s address is determined and stored in <code>Elf64_Symbol.value</code> </li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains 12 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">11: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND sum</span><br><span class="line"><span class="comment"># value change from 0x0 to PC_rela_address</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>After that, every call to <code>sum</code> will use the address find in <code>.symtab</code></li>
</ol>
<h4 id="Relocating-Absolute-References"><a href="#Relocating-Absolute-References" class="headerlink" title="Relocating Absolute References"></a>Relocating Absolute References</h4><p>Almost the same with PC relative method, just put the <code>ADDR(s.symbol)</code> directly into the <code>Elf64_Symbol.value</code>  field</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> *refptr = (<span class="keyword">unsigned</span>) (ADDR(r.symbol) + r.addend);</span><br><span class="line"><span class="comment">//actual address + bias</span></span><br></pre></td></tr></table></figure>
<h2 id="7-8-Executable-Object-Files"><a href="#7-8-Executable-Object-Files" class="headerlink" title="7.8 Executable Object Files"></a>7.8 Executable Object Files</h2><p><em>Our example C program, which began life as a collection of ASCII text files, has been transformed into a single binary file that contains all of the information needed to load the program into memory and run it.</em></p>
<p><img src="/2021/09/19/CSAPP/Ch7/elfstruct.png" alt="elf structure"></p>
<ul>
<li>The format of an executable object file is similar to that of a relocatable object file.(But NOT identical !)</li>
<li> It includes the program’s <strong>entry point</strong>, which is the address of the first instruction to execute when the program runs</li>
<li>The <code>.init</code> section defines a small function, called <code>_init</code>, that will be called by the program’s initialization code</li>
<li>Since the executable is fully linked (relocated), it needs no <code>.rel</code> sections.</li>
</ul>
<p>ELF executables are designed to be easy to load into memory, with contiguous chunks of the executable file mapped to contiguous memory segments.</p>
<p><img src="/2021/09/19/CSAPP/Ch7/pht.png" alt="program header table"></p>
<ul>
<li><p>This mapping is described by the <code>program header table</code>. </p>
</li>
<li><p>For any segment <code>s</code> in objective file, the linker must choose a starting address, <code>vaddr</code>, such that </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vaddr % align == off % align</span><br></pre></td></tr></table></figure>
<ul>
<li><code>off</code> is the offset of the segment’s first section in the object file</li>
<li><code>align</code> is the alignment specified in the program header $(2^{21} = (200000)_{16})$</li>
</ul>
</li>
<li><p>This alignment requirement is an <strong>optimization</strong> that enables segments in the object file to be transferred efficiently to memory when the program executes</p>
</li>
</ul>
<p>Both <code>readelf</code> and <code>objdump</code> is useful</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -l stand for --program-headers</span></span><br><span class="line">$ readelf -l program </span><br><span class="line">$ objdump -x program</span><br></pre></td></tr></table></figure>
<h2 id="7-9-Loading-Executable-Object-Files"><a href="#7-9-Loading-Executable-Object-Files" class="headerlink" title="7.9 Loading Executable Object Files"></a>7.9 Loading Executable Object Files</h2><p>If you want to run a non-built-in program, you type <code>/path/program</code> to run it</p>
<p><em>The <code>shell</code> runs for us by invoking some memory-resident operating system code known as the <code>loader</code></em></p>
<ul>
<li>Any Linux program can invoke the <code>loader</code> by calling the <code>execve</code> function</li>
<li>The <code>loader</code> copies the <strong>code and data</strong> in the executable object file from disk into memory and then runs the program by jumping to its first instruction, or <code>entry point</code>. </li>
</ul>
<p><img src="/2021/09/19/CSAPP/Ch7/runtimeimg.png" alt="run time image"></p>
<ul>
<li>When the <code>loader</code> runs, it creates a memory image</li>
<li>Guided by the <code>program header table</code>, it copies chunks of the executable object file into the code and data segments.</li>
<li>Next, the <code>loader</code> jumps to the program’s <code>entry point</code>, which is always the address of the <code>_start</code> function<ul>
<li>This function is defined in the system object file <code>crt1.o</code> and is the same for all C programs. </li>
<li>The <code>_start</code> function calls the <code>system startup function</code>, <code>__libc_start_ main</code>, which is defined in <code>libc.so</code>.</li>
<li>It initializes the execution environment, calls the user-level <code>main</code> function, handles its return value, and if necessary returns control to the kernel.</li>
</ul>
</li>
</ul>
<h2 id="7-10-Dynamic-Linking-with-Shared-Libraries"><a href="#7-10-Dynamic-Linking-with-Shared-Libraries" class="headerlink" title="7.10 Dynamic Linking with Shared Libraries"></a>7.10 Dynamic Linking with Shared Libraries</h2><p><em>Static libraries still have some significant disadvantages</em></p>
<ul>
<li>Static libraries, like all software, need to be maintained and updated periodically(relinking required in every update)</li>
<li> Almost every C program uses standard I/O functions. At run time, the code for these functions is duplicated in the text segment of each running process</li>
</ul>
<p><em>Shared libraries are modern innovations that address the disadvantages of static libraries.</em></p>
<p><em>A shared library is <strong>an object module that, at either run time or load time, can be loaded at an arbitrary memory address and linked with a program in memory.</strong></em></p>
<ul>
<li>This process is known as <code>dynamic linking</code> and is performed by a program called a <code>dynamic linker</code></li>
<li> Shared libraries are also referred to as shared objects, and on Linux systems they are indicated by the <code>.so</code> suffix</li>
</ul>
<p>Shared libraries are “shared” in two different ways. </p>
<ul>
<li>In any given file system, there is exactly one <code>.so</code> file for a particular library.<ul>
<li>The code and data in this <code>.so</code> file are shared by all of the executable object files that reference the library</li>
<li>opposed to the contents of static libraries, which are <strong>copied and embedded</strong> in the executables that reference them</li>
</ul>
</li>
<li>A single copy of the <code>.text</code> section of a shared library in memory can be shared by different running processes</li>
</ul>
<p>A concrete example:</p>
<p><img src="/2021/09/19/CSAPP/Ch7/dlink.png" alt="shared library dynamic link"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -shared -fpic -o libvector.so addvec.c mulvec.c</span><br></pre></td></tr></table></figure>
<ul>
<li>The <code>-fpic</code> flag directs the compiler to generate <strong>position-independent code</strong></li>
<li>The <code>-shared</code> flag directs the linker to create a shared object file</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -o prog2l main2.c ./libvector.so</span><br></pre></td></tr></table></figure>
<ul>
<li><p><em>The basic idea is to <strong>do some of the linking statically when the executable file is created, and then complete the linking process dynamically when the program is loaded</strong>.</em></p>
</li>
<li><p>The linker ONLY copies some <strong>relocation and symbol table information</strong> that will allow references to code and data in libvector.so to be resolved at load time</p>
</li>
</ul>
<h5 id="Execution"><a href="#Execution" class="headerlink" title="Execution"></a>Execution</h5><ul>
<li>When the loader loads and runs the executable <code>prog2l</code>, it loads the partially linked executable </li>
<li>Next, it notices that <code>prog2l</code> contains a <code>.interp</code> section, which contains the path name of the dynamic linker (e.g., <code>ld-linux.so</code> on Linux systems)</li>
<li>the loader loads and runs the dynamic linker</li>
<li>The dynamic linker then finishes the linking task by performing the following relocations:<ul>
<li>Relocating the <code>text</code> and <code>data</code> of <code>libc.so</code> into some memory segment</li>
<li>Relocating the <code>text</code> and <code>data</code> of <code>libvector.so</code> into another memory segment</li>
<li>Relocating any references in <code>prog2l</code> to symbols defined by <code>libc.so</code> and <code>libvector.so</code></li>
</ul>
</li>
<li>Finally, the dynamic linker passes control to the application</li>
</ul>
<h2 id="7-11-Loading-and-Linking-Shared-Libraries-from-Applications"><a href="#7-11-Loading-and-Linking-Shared-Libraries-from-Applications" class="headerlink" title="7.11 Loading and Linking Shared Libraries from Applications"></a>7.11 Loading and Linking Shared Libraries from Applications</h2><p><em>It is also possible for an application to request the dynamic linker to load and link arbitrary shared libraries while the application is running.</em></p>
<p>Linux systems provide a <strong>simple interface to the dynamic linker</strong> that allows application programs to load and link shared libraries at run time.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">dlopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> flag)</span></span>;</span><br><span class="line"><span class="comment">//Returns: pointer to handle if OK. NULL on error.</span></span><br><span class="line"><span class="comment">// A handle is something like a `FILE*`</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>The <code>dlopen</code> function loads and links the shared library filename.</p>
</li>
<li><p>The external symbols in filename are resolved using libraries previously opened with the <code>RTLD_ GLOBAL</code> flag.</p>
<p> If the current executable was compiled with the <code>-rdynamic</code> flag, then its global symbols are also available for symbol resolution.</p>
</li>
<li><p>The flag argument must include either <code>RTLD_NOW</code>, which tells the linker to resolve references to external symbols immediately, or the <code>RTLD_LAZY</code> flag, which instructs the linker to defer symbol resolution until code from the library is executed. </p>
<p>Either of these values can be <code>|</code> with the <code>RTLD_GLOBAL</code> flag.</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">dlsym</span><span class="params">(<span class="keyword">void</span> *handle, <span class="keyword">char</span> *symbol)</span></span>;</span><br><span class="line"><span class="comment">//Returns: pointer to symbol if OK. NULL on error</span></span><br></pre></td></tr></table></figure>
<ul>
<li>The <code>dlsym</code> function takes a handle to a previously opened shared library and a symbol name and returns the address of the symbol, if it exists, or <code>NULL</code> otherwise.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dlclose</span> <span class="params">(<span class="keyword">void</span> *handle)</span></span>;</span><br><span class="line"><span class="comment">//Returns: 0 if OK, −1 on error</span></span><br></pre></td></tr></table></figure>
<p>The <code>dlclose</code> function unloads the shared library if no other shared libraries are still using it.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">dlerror</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="comment">//Returns: error message if previous call to dlopen, dlsym, or dlclose failed;</span></span><br><span class="line"><span class="comment">//NULL if previous call was OK</span></span><br></pre></td></tr></table></figure>
<p>An example of using this interface to dynamically link  <code>libvector.so</code> shared library at run time and then invoke its <code>addvec</code> routine</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> x[<span class="number">2</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> y[<span class="number">2</span>] = &#123;<span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> z[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line"> <span class="keyword">void</span> * handle;</span><br><span class="line"> <span class="keyword">void</span> (*addvec)(<span class="keyword">int</span> *, <span class="keyword">int</span> *, <span class="keyword">int</span> *, <span class="keyword">int</span>); <span class="comment">// a function pointer to the function we want</span></span><br><span class="line"> <span class="keyword">char</span> *error;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Dynamically load the shared library containing addvec() */</span></span><br><span class="line"> handle = dlopen(<span class="string">&quot;./libvector.so&quot;</span>, RTLD_LAZY);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (!handle) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>, dlerror());</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Get a pointer to the addvec() function we just loaded */</span></span><br><span class="line"> addvec = dlsym(handle, <span class="string">&quot;addvec&quot;</span>);</span><br><span class="line"> <span class="keyword">if</span> ((error = dlerror()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>, error);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Now we can call addvec() just like any other function */</span></span><br><span class="line"> addvec(x, y, z, <span class="number">2</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;z = [%d %d]\n&quot;</span>, z[<span class="number">0</span>], z[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Unload the shared library */</span></span><br><span class="line"> <span class="keyword">if</span> (dlclose(handle) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>, dlerror());</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"> &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -rdynamic -o prog2r dll.c -ldl</span><br><span class="line"><span class="comment"># -ldl stand for libdl.a</span></span><br><span class="line"><span class="comment"># If we want to use &lt;dlfnc.h&gt;</span></span><br><span class="line">$ locate libdl.a</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libdl.a</span><br></pre></td></tr></table></figure>
<h2 id="7-12-Position-Independent-Code-PIC"><a href="#7-12-Position-Independent-Code-PIC" class="headerlink" title="7.12 Position-Independent Code (PIC)"></a>7.12 Position-Independent Code (PIC)</h2><p><em>A key purpose of shared libraries is to allow <strong>multiple running processes to share the same library code in memory</strong> and thus save precious memory resources</em></p>
<ul>
<li><p>Modern systems compile the <strong>code segments of shared modules</strong> so that they can be loaded anywhere in memory without having to be modified by the linker.</p>
</li>
<li><p>Users direct GNU compilation systems to generate PIC code with the <code>-fpic </code>option to gcc. Shared libraries must always be compiled with this option.</p>
</li>
</ul>
<h3 id="PIC-Data-References"><a href="#PIC-Data-References" class="headerlink" title="PIC Data References"></a>PIC Data References</h3><p><em>Important fact : no matter where we load an object module (including shared object modules) in memory, the data segment is always the same distance from the code segment.</em></p>
<ul>
<li>Compilers that want to generate PIC references to global variables exploit this fact by creating a table called the <code>global offset table (GOT)</code> at the <strong>beginning of the data segment</strong>.</li>
<li>The GOT contains an 8-byte entry for each global data object (procedure or global variable) that is <strong>referenced by the object module.</strong></li>
<li>The compiler also generates a relocation record for each entry in the GOT.</li>
<li>At <strong>load time</strong>, the dynamic linker relocates each GOT entry so that it contains the absolute address of the object</li>
</ul>
<p><img src="/2021/09/19/CSAPP/Ch7/got.png" alt="got"></p>
<h3 id="PIC-Function-Calls"><a href="#PIC-Function-Calls" class="headerlink" title="PIC Function Calls"></a>PIC Function Calls</h3><p><em>The compiler has no way of predicting the run-time address of the function, since the shared module could be loaded anywhere at run time.</em></p>
<p><em>GNU compilation systems solve this problem using an interesting technique, called <code>lazy binding</code>, that defers the binding of each procedure address until <strong>the first time the procedure is called</strong>.</em></p>
<p>Lazy binding is implemented with a compact yet somewhat complex interaction between two data structures: the <code>GOT</code> and the <code>procedure linkage table (PLT)</code>.</p>
<ul>
<li>The GOT is part of the data segment. The PLT is part of the code segment.</li>
<li>The <code>PLT</code> is an array of 16-byte code entries. <ul>
<li><code>PLT[0]</code> is a special entry that jumps into the <strong>dynamic linker</strong></li>
<li><code>PLT[1]</code> invokes the system startup function (<code>__libc_start_main</code>), which initializes the execution environment, calls the <code>main</code> function, and handles its return value.</li>
<li>Entries starting at <code>PLT[2]</code> invoke functions called by the user code. </li>
</ul>
</li>
<li>When used in conjunction with the <code>PLT</code>, <code>GOT[0]</code> and <code>GOT[1]</code> contain information that the dynamic linker uses when it resolves function addresses<ul>
<li><code>GOT[2]</code> is the entry point for the dynamic linker in the <code>ld-linux.so</code> module</li>
<li>Each of the remaining entries corresponds to a called function whose address needs to be resolved at run time. Each has a matching PLT entry.</li>
<li>Initially, each GOT entry points to the second instruction in the corresponding PLT entry.</li>
</ul>
</li>
</ul>
<p><img src="/2021/09/19/CSAPP/Ch7/gotandplt.png" alt="got and plt"></p>
<ol>
<li>Instead of directly calling <code>addvec</code>, the program calls into <code>PLT[2]</code>, which is the <code>PLT</code> entry for <code>addvec</code>.</li>
<li>The first <code>PLT</code> instruction does an indirect jump through <code>GOT[4]</code>. Since each <code>GOT</code> entry initially points to the second instruction in its corresponding <code>PLT</code> entry, the indirect jump simply transfers control back to the next instruction in <code>PLT[2]</code>.</li>
<li>After pushing an <strong>ID</strong> for <code>addvec,(0x1) </code>onto the stack, <code>PLT[2]</code> jumps to <code>PLT[0]</code></li>
<li><code>PLT[0]</code> pushes <strong>an argument for the dynamic linker</strong> indirectly through <code>GOT[1]</code> and then jumps into the dynamic linker indirectly through <code>GOT[2]</code>.</li>
<li>The <strong>dynamic linker uses the two stack entries to determine the runtime location of <code>addvec</code></strong>, overwrites <code>GOT[4]</code> with this address, and passes control to <code>addvec</code>.</li>
</ol>
<hr>
<p><strong><em>Most of the job are done by the dynamic linker during run time, including fill in the GOT</em></strong></p>
<hr>
<h2 id="7-13-Library-Interpositioning"><a href="#7-13-Library-Interpositioning" class="headerlink" title="7.13 Library Interpositioning"></a>7.13 Library Interpositioning</h2><p><em>Linux linkers support a powerful technique, called <strong>library interpositioning</strong>, that <strong>allows you to intercept calls to shared library functions and execute your own code instead</strong>.</em></p>
<ul>
<li><p>Using interpositioning, you could trace the number of times a particular library function is called, validate and trace its input and output values, or even replace it with a completely different implementation.</p>
</li>
<li><p><strong>Basic idea</strong>: Given some target function to be interposed on, you create a <strong>wrapper function</strong> whose prototype is identical to the target function.</p>
<p>Using some particular interpositioning mechanism, you then trick the system into calling the wrapper function instead of the target function. The wrapper function typically executes its own logic, then calls the target function and passes its return value back to the caller.</p>
</li>
<li><p>Interpositioning can occur at compile time, link time, or run time as the program is being loaded and executed.</p>
</li>
</ul>
<p>Example program</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//int.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> *p = <span class="built_in">malloc</span>(<span class="number">32</span>);</span><br><span class="line"><span class="built_in">free</span>(p);</span><br><span class="line"><span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//malloc.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> malloc(size) mymalloc(size)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> free(ptr) myfree(ptr)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mymalloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfree</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//malloc.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILETIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* malloc wrapper function */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mymalloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">void</span> *ptr = <span class="built_in">malloc</span>(size);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;malloc(%d)=%p\n&quot;</span>,</span><br><span class="line"> (<span class="keyword">int</span>)size, ptr);</span><br><span class="line"> <span class="keyword">return</span> ptr;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* free wrapper function */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">myfree</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line"> <span class="built_in">free</span>(ptr);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;free(%p)\n&quot;</span>, ptr);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LINKTIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *__real_malloc(<span class="keyword">size_t</span> size);</span><br><span class="line"><span class="keyword">void</span> __real_free(<span class="keyword">void</span> *ptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* malloc wrapper function */</span></span><br><span class="line"><span class="keyword">void</span> *__wrap_malloc(<span class="keyword">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">void</span> *ptr = __real_malloc(size); <span class="comment">/* Call libc malloc */</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;malloc(%d) = %p\n&quot;</span>, (<span class="keyword">int</span>)size, ptr);</span><br><span class="line"> <span class="keyword">return</span> ptr;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* free wrapper function */</span></span><br><span class="line"> <span class="keyword">void</span> __wrap_free(<span class="keyword">void</span> *ptr)</span><br><span class="line"> &#123;</span><br><span class="line"> __real_free(ptr); <span class="comment">/* Call libc free */</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;free(%p)\n&quot;</span>, ptr);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="7-13-1-Compile-Time-Interpositioning"><a href="#7-13-1-Compile-Time-Interpositioning" class="headerlink" title="7.13.1 Compile-Time Interpositioning"></a>7.13.1 Compile-Time Interpositioning</h3><p><em>use the C preprocessor to interpose at compile time.</em></p>
<p>The local <code>malloc.h</code> header file instructs the preprocessor to replace each call to a target function with a call to its wrapper.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -DCOMPILETIME -c mymalloc.c</span><br><span class="line"><span class="comment"># -D name means predefine name as a macro</span></span><br><span class="line">$ gcc -I. -o intc int.c mymalloc.o</span><br><span class="line"><span class="comment"># -I tells the C preprocessor to look for malloc.h in the current directory before looking in the usual system directories</span></span><br><span class="line">$ ./intc</span><br><span class="line">malloc(32)=0x55999c4fb260</span><br><span class="line">free(0x55999c4fb260)</span><br></pre></td></tr></table></figure>
<p>Notice that the wrappers in <code>mymalloc.c</code> are compiled with the standard <code>malloc.h</code> header file(No <code>-I</code> option specified)</p>
<h3 id="7-13-2-Link-Time-Interpositioning"><a href="#7-13-2-Link-Time-Interpositioning" class="headerlink" title="7.13.2 Link-Time Interpositioning"></a>7.13.2 Link-Time Interpositioning</h3><p><em>The Linux static linker supports link-time interpositioning with the <code>--wrap f</code> flag</em></p>
<ul>
<li>This flag tells the linker to resolve references to symbol <code>f</code> as<code> __wrap_f</code></li>
<li>and to resolve references to symbol<code> __real_f</code>  as <code>f</code>.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -D LINKTIME -c mymalloc.c</span><br><span class="line">$ gcc -c int.c</span><br><span class="line">$ gcc -Wl,--wrap,malloc -Wl,--wrap,free -o intl int.o mymalloc.o</span><br></pre></td></tr></table></figure>
<ul>
<li>The <code>-Wl,option</code> flag passes option to the linker.</li>
<li>Each comma in option will be replaced with a space. </li>
<li>So <code>-Wl,--wrap,malloc</code> passes <code>--wrap malloc</code> to the linker</li>
</ul>
<h3 id="7-13-3-Run-Time-Interpositioning"><a href="#7-13-3-Run-Time-Interpositioning" class="headerlink" title="7.13.3 Run-Time Interpositioning"></a>7.13.3 Run-Time Interpositioning</h3><p><em>Compile-time interpositioning requires access to a program’s source files. Linktime interpositioning requires access to its relocatable object files</em></p>
<p><strong><em>However, there is a mechanism for interpositioning at run time that requires access only to the executable object file</em></strong></p>
<p>This fascinating mechanism is based on the dynamic linker’s <code>LD_PRELOAD </code>environment variable.</p>
<p>If the <code>LD_PRELOAD</code> environment variable is set to a list of shared library pathnames (separated by spaces or colons), then when you load and execute a program, the dynamic linker <code>(ld-linux.so)</code> will search the <code>LD_PRELOAD </code>libraries first, before any other shared libraries, when it resolves undefined references.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mymalloc.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RUNTIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* malloc wrapper function */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">void</span> *(*mallocp)(<span class="keyword">size_t</span> size);</span><br><span class="line"> <span class="keyword">char</span> *error;</span><br><span class="line"></span><br><span class="line"> mallocp = dlsym(RTLD_NEXT, <span class="string">&quot;malloc&quot;</span>); </span><br><span class="line">    <span class="comment">/* RTLD_NEXT tells dlsym to use the second found malloc(libc version) rather than the first one(our own version)*/</span></span><br><span class="line">    <span class="comment">/* Get address of libc malloc */</span></span><br><span class="line"> <span class="keyword">if</span> ((error = dlerror()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line"> <span class="built_in">fputs</span>(error, <span class="built_in">stderr</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">char</span> *ptr = mallocp(size); <span class="comment">/* Call libc malloc */</span></span><br><span class="line"> <span class="comment">//printf(&quot;malloc(%d) = %p\n&quot;, (int)size, ptr);</span></span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span> , <span class="string">&quot;malloc(%d) = %p\n&quot;</span>, (<span class="keyword">int</span>)size, ptr);</span><br><span class="line"> <span class="keyword">return</span> ptr;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* free wrapper function */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line"> <span class="keyword">void</span> (*freep)(<span class="keyword">void</span> *) = <span class="literal">NULL</span>;</span><br><span class="line"> <span class="keyword">char</span> *error;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (!ptr)</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"> freep = dlsym(RTLD_NEXT, <span class="string">&quot;free&quot;</span>); <span class="comment">/* Get address of libc free */</span></span><br><span class="line"> <span class="keyword">if</span> ((error = dlerror()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line"> <span class="built_in">fputs</span>(error, <span class="built_in">stderr</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> freep(ptr); <span class="comment">/* Call libc free */</span></span><br><span class="line"> <span class="comment">//printf(&quot;free(%p)\n&quot;, ptr);</span></span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span> , <span class="string">&quot;free(%p)\n&quot;</span>, ptr);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">The code on the book has some subtle errors, printf will use stdout, which result in conflict with other program&#x27;s code.</span></span><br><span class="line"><span class="comment">Switch to stderr will thwart the error</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -D RUNTIME -shared -fpic -o mymalloc.so mymalloc.c -ldl</span><br><span class="line">$ gcc -o intr int.c</span><br><span class="line">$ LD_PRELOAD=<span class="string">&quot;./mymalloc.so&quot;</span> ./intr</span><br></pre></td></tr></table></figure>
<p><span style="color:red">Notice that you can use <code>LD_PRELOAD</code> to interpose on the library calls of any executable program!</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ LD_PRELOAD=<span class="string">&quot;./mymalloc.so&quot;</span> /usr/bin/uptime</span><br><span class="line">$ LD_PRELOAD=<span class="string">&quot;./mymalloc.so&quot;</span> ls</span><br></pre></td></tr></table></figure>
<h2 id="7-14-Tools-for-Manipulating-Object-Files"><a href="#7-14-Tools-for-Manipulating-Object-Files" class="headerlink" title="7.14 Tools for Manipulating Object Files"></a>7.14 Tools for Manipulating Object Files</h2><ul>
<li><code>ar</code> Creates static libraries, and inserts, deletes, lists, and extracts members.</li>
<li><code>strings</code> Lists all of the printable strings contained in an object file</li>
<li><code>strip</code> Deletes symbol table information from an object file</li>
<li><code>nm</code> Lists the symbols defined in the symbol table of an object file</li>
<li><code>size</code> Lists the names and sizes of the sections in an object file</li>
<li><code>readelf</code> Displays the complete structure of an object file, including all of the information encoded in the ELF header. Subsumes the functionality of <code>size</code> and <code>nm</code></li>
<li><code>objdump</code> The mother of all binary tools. Can display all of the information in an object file.</li>
<li><code>ldd</code> Lists the shared libraries that an executable needs at run time.</li>
</ul>
<h2 id="7-15-Summary"><a href="#7-15-Summary" class="headerlink" title="7.15 Summary"></a>7.15 Summary</h2><p>Library interposition is very powerful</p>
<p><a target="_blank" rel="noopener" href="https://axcheron.github.io/playing-with-ld_preload/">hook</a></p>
<p><a target="_blank" rel="noopener" href="https://axcheron.github.io/exploit-101-format-strings/">GOT modification</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://rubbish-and-world.github.io/2021/09/19/CSAPP/Ch7/" data-id="clqcg0iuq00262dyq9x3xdwht" data-title="Ch7" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/09/20/CSAPP/perflab/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          perflab
        
      </div>
    </a>
  
  
    <a href="/2021/09/13/CSAPP/attacklab/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">attacklab</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Cryptography/">Cryptography</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Structure/">Data Structure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Electronics/">Electronics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FrontEnd/">FrontEnd</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/FrontEnd/course/">course</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/IOT/">IOT</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LLL/">LLL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/">Machine Learning</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/NTU/">NTU</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/Stanford-CS229/">Stanford CS229</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Math/Discrete-Mathematics/">Discrete Mathematics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/Linear-Algebra/">Linear Algebra</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/Statistics/">Statistics</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Missing-Semester/">Missing Semester</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Networking/">Networking</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Networking/Stanford-CS144/">Stanford CS144</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/OS/30DayOS/">30DayOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/TEP/">TEP</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python-OG/">Python OG</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web3/">Web3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/csapp/">csapp</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/feelings/">feelings</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/misc/">misc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/noval/">noval</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/game/" rel="tag">game</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/game/" style="font-size: 10px;">game</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/01/01/feelings/2024/">2024</a>
          </li>
        
          <li>
            <a href="/2023/12/26/miscellaneous/RealWorld/">RealWorld</a>
          </li>
        
          <li>
            <a href="/2023/12/20/Web3/Blockchain/TechBasic/">TechBasic</a>
          </li>
        
          <li>
            <a href="/2023/12/19/Web3/Blockchain/Money-Ledger-Bitcoin/">Money-Ledger-Bitcoin</a>
          </li>
        
          <li>
            <a href="/2023/12/10/Web3/Blockchain/MIT15-S12/">MIT15.S12</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 rubbish<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>