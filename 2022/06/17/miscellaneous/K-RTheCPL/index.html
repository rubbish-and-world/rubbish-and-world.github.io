<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>K&amp;RTheCPL | RainbowBin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Some notes about reading the 《K&amp;C The C Programming language》">
<meta property="og:type" content="article">
<meta property="og:title" content="K&amp;RTheCPL">
<meta property="og:url" content="http://rubbish-and-world.github.io/2022/06/17/miscellaneous/K-RTheCPL/index.html">
<meta property="og:site_name" content="RainbowBin">
<meta property="og:description" content="Some notes about reading the 《K&amp;C The C Programming language》">
<meta property="og:locale">
<meta property="og:image" content="http://rubbish-and-world.github.io/2022/06/17/miscellaneous/K-RTheCPL/table.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2022/06/17/miscellaneous/K-RTheCPL/precedence.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2022/06/17/miscellaneous/K-RTheCPL/vs.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2022/06/17/miscellaneous/K-RTheCPL/theyaresame.png">
<meta property="og:image" content="http://rubbish-and-world.github.io/2022/06/17/miscellaneous/K-RTheCPL/more.png">
<meta property="og:image" content="http://e2fsprogs.sourceforge.net/ext2-vfs.gif">
<meta property="og:image" content="http://www.porcupine.org/forensics/forensic-discovery/figure3.3.gif">
<meta property="og:image" content="https://tldp.org/LDP/tlk/fs/ext2.gif">
<meta property="og:image" content="https://tldp.org/LDP/tlk/fs/ext2_inode.gif">
<meta property="og:image" content="https://practice.geeksforgeeks.org/ckeditor/images/uploads/1493710190_10-34.jpg">
<meta property="article:published_time" content="2022-06-17T05:05:05.000Z">
<meta property="article:modified_time" content="2022-06-29T10:29:03.188Z">
<meta property="article:author" content="rubbish">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://rubbish-and-world.github.io/2022/06/17/miscellaneous/K-RTheCPL/table.png">
  
    <link rel="alternate" href="/atom.xml" title="RainbowBin" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">RainbowBin</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://rubbish-and-world.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-miscellaneous/K-RTheCPL" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/17/miscellaneous/K-RTheCPL/" class="article-date">
  <time class="dt-published" datetime="2022-06-17T05:05:05.000Z" itemprop="datePublished">2022-06-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/misc/">misc</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      K&amp;RTheCPL
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="Some-notes-about-reading-the-《K-amp-C-The-C-Programming-language》"><a href="#Some-notes-about-reading-the-《K-amp-C-The-C-Programming-language》" class="headerlink" title="Some notes about reading the 《K&amp;C The C Programming language》"></a>Some notes about reading the 《K&amp;C The C Programming language》</h3><a id="more"></a>

<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p><em>C is not a big language, and it is not well served by a big book.</em></p>
<p><em>C is <strong>not</strong> a <code>very high level</code> language, <strong>nor</strong> a <code>big</code> one, and is <strong>not</strong> specialized to any particular area of application.</em></p>
<p>Besides showing how to make effective use of the language, we have also tried where possible to illustrate useful algorithms and principles of good style and sound design.</p>
<h1 id="CH1-A-Tutorial-Introduction"><a href="#CH1-A-Tutorial-Introduction" class="headerlink" title="CH1 A Tutorial Introduction"></a>CH1 A Tutorial Introduction</h1><p><em>The only way to learn a new programming language is by writing programs in it.</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* integer division truncates: any fractional part is discarded. */</span></span><br><span class="line"><span class="number">5</span> / <span class="number">9</span> == <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/06/17/miscellaneous/K-RTheCPL/table.png" alt="table"></p>
<h4 id="Magic-Number"><a href="#Magic-Number" class="headerlink" title="Magic Number"></a>Magic Number</h4><p><em>they convey little information to someone who might have to read the program later, and they are hard to change in a systematic way.</em></p>
<p>One way to deal with magic numbers is to give them meaningful names. A <code>#define</code> line defines a <strong>symbolic name</strong> or <strong>symbolic constant</strong> to be a particular string of characters</p>
<h4 id="Text"><a href="#Text" class="headerlink" title="Text"></a>Text</h4><p><em>A text stream is a sequence of characters divided into lines; <strong>each line consists of zero or more characters followed by a newline character</strong>. It is the responsibility of the library to make each input or output stream confirm this model</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x\n&quot;</span> , EOF);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span> , <span class="keyword">sizeof</span>(EOF));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* output */</span></span><br><span class="line">ffffffff</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="comment">//EOF is 32 bits, not enough for `char` to hold</span></span><br></pre></td></tr></table></figure>
<p><strong>When you need precise control over the character flow, use <code>getchar</code> instead of <code>scanf</code> !</strong></p>
<blockquote>
<p>Step to write a program :</p>
<ol>
<li><p>Define the problem<br>questions like “What is a ‘word’”,”What is a ‘shortest path’”,etc</p>
</li>
<li><p>Compose test cases</p>
<p>Try to include all boundary conditions, special cases and large/tiny scale of the problem(<code>len(input) == 0 or len(input) &gt;= 2 ** 32</code>). And you can make the definition more concise</p>
</li>
<li><p>Come up with the ‘right’ algorithm and data structure, solve the problem on paper/iPad first.</p>
<p><strong>You show always spend most of your time planning and solving problem on paper. After you get the right idea, writing code will not cost much time!!!</strong></p>
</li>
<li><p>Write the code</p>
</li>
</ol>
</blockquote>
<h4 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h4><p>local variables are also called <strong>automatic</strong> variables, as they born and recollected automatically, in contrary to <code>static</code> and <code>global/extern</code> variables</p>
<blockquote>
<p>Before a function can use an external variable, the name of the variable must be made known to the function; the declaration is the same as before<br>except for the added keyword <code>extern</code>.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">returnglobal</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">int</span> global ; <span class="comment">// declare that there is a global int</span></span><br><span class="line">                        <span class="comment">// somewhere out of the function</span></span><br><span class="line">    <span class="keyword">return</span> global; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In certain circumstances, the extern declaration can be omitted. If the definition of the external variable occurs in the source file before its use in a particular function, then there is no need for an extern declaration in the function.</p>
</blockquote>
<h1 id="CH2-Types-Operators-and-Objects"><a href="#CH2-Types-Operators-and-Objects" class="headerlink" title="CH2 Types, Operators and Objects"></a>CH2 Types, Operators and Objects</h1><h3 id="Variable-name"><a href="#Variable-name" class="headerlink" title="Variable name"></a>Variable name</h3><p><em>Names are made up of <strong>letters and digits</strong>; the <strong>first character must be a letter</strong>.</em></p>
<ul>
<li><p>library routines often use name begin with a <code>_</code></p>
</li>
<li><p>Upper and lower case letters are distinct</p>
<ul>
<li><p>lower for variable name</p>
</li>
<li><p>upper for symbolic constants(the macro)</p>
</li>
</ul>
</li>
</ul>
<h3 id="Variable-size"><a href="#Variable-size" class="headerlink" title="Variable size"></a>Variable size</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limit.h&gt; // implementation defined for integers</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;float.h&gt; // implementation defined for float point</span></span></span><br></pre></td></tr></table></figure>
<h3 id="Constants"><a href="#Constants" class="headerlink" title="Constants"></a>Constants</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1234</span> <span class="comment">// int</span></span><br><span class="line"><span class="number">1234l</span> <span class="comment">// long int</span></span><br><span class="line"><span class="number">1234u</span> <span class="comment">// unsigned int</span></span><br><span class="line"><span class="number">1234ul</span> <span class="comment">//unsigned long int</span></span><br><span class="line"><span class="number">9999999999999999999</span> <span class="comment">// long</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.0</span> <span class="comment">// double</span></span><br><span class="line"><span class="number">1.0f</span> <span class="comment">// float</span></span><br><span class="line"><span class="number">1.0l</span> <span class="comment">// long double</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0123</span> <span class="comment">// oct number</span></span><br><span class="line"><span class="number">0x123</span> <span class="comment">// hex number</span></span><br><span class="line"><span class="number">0b1001</span> <span class="comment">// binary number </span></span><br></pre></td></tr></table></figure>
<p>A constant expression is an expression that <strong>involves only constants</strong>. Such expressions may be evaluated at during compilation rather than run-time, and accordingly may be used in any place that a constant can occur, for example, <strong>array definition</strong></p>
<p>The standard library function <code>strlen(s)</code> returns the length of its character string argument <code>s</code>, <strong>excluding the terminal <code>&#39;\0&#39;</code>.</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;a&#x27;</span> <span class="comment">// integer value 97</span></span><br><span class="line"><span class="string">&quot;a&quot;</span> <span class="comment">// array of chars: [&#x27;a&#x27; , &#x27;\0&#x27;]</span></span><br></pre></td></tr></table></figure>
<h5 id="enumeration-constant"><a href="#enumeration-constant" class="headerlink" title="enumeration constant"></a>enumeration constant</h5><p><em>An enumeration is <strong>a list of constant integer values</strong>.</em></p>
<p>Enumerations provide a convenient way to associate constant values with names, an alternative to <code>#define</code> with the advantage that the values can be generated for you.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">name</span> &#123;</span> var1 , var2 , var3 &#125;; <span class="comment">//definition</span></span><br><span class="line"><span class="comment">// vars automatically get the value</span></span><br><span class="line"><span class="comment">// var1 = 0 , var2 = var1+1 var3= var2 + 1</span></span><br><span class="line"><span class="keyword">int</span> var = var1 ; <span class="comment">//usage</span></span><br><span class="line"><span class="comment">//We don&#x27;t need to refer to the `name` since Names in different enumerations must be distinct when we define it.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Make a Python-like boolean type when &lt;stdbool.h&gt; is missing</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bools</span> &#123;</span> False , True &#125;;</span><br><span class="line"><span class="keyword">if</span> ( True )&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Arithmetic"><a href="#Arithmetic" class="headerlink" title="Arithmetic"></a>Arithmetic</h4><p><em>The <code>%</code> operator cannot be applied to a float or double.</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!valid) <span class="comment">// read nicely by &quot;If not valid&quot;</span></span><br><span class="line">            <span class="comment">// ! serves as `not` in Python</span></span><br></pre></td></tr></table></figure>
<h4 id="Characters"><a href="#Characters" class="headerlink" title="Characters"></a>Characters</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="comment">//defines a family of functions that provide tests and conversions</span></span><br><span class="line"><span class="comment">// that are independent of character set.</span></span><br><span class="line"><span class="comment">// (No matter it is UTF-8 or ASCII or EBCDIC)</span></span><br></pre></td></tr></table></figure>
<p>For portability, specify <code>signed</code> or <code>unsigned</code> if non-<br>character data is to be stored in char variables.</p>
<h4 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">++c ; <span class="comment">// increments c before its value is used</span></span><br><span class="line">c++ ; <span class="comment">// increments c after its value is used</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c += <span class="number">1</span> + <span class="number">2</span>  <span class="comment">// c += (1+2)</span></span><br><span class="line">            <span class="comment">// c = c + 1 + 2</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">operator= always have lower precedence than normal operators</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">condition ? res1 : res2 ; <span class="comment">// this is an expression</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">If expr2 and expr3 are of different types,</span></span><br><span class="line"><span class="comment">the type of the result is determined by the conversion rules</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//write succinct code</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;%6d%c&quot;</span>, a[i], (i%<span class="number">10</span>==<span class="number">9</span> || i==n<span class="number">-1</span>) ? <span class="string">&#x27;\n&#x27;</span> : <span class="string">&#x27; &#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">this loop prints n elements of an array, 10 per line, </span></span><br><span class="line"><span class="comment">with each column separated by one blank, </span></span><br><span class="line"><span class="comment">and with each line (including the last) terminated by a newline.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h4 id="Precedence"><a href="#Precedence" class="headerlink" title="Precedence"></a>Precedence</h4><p>Operators on the same line have the same precedence;<br>rows are in order of decreasing precedence</p>
<p><img src="/2022/06/17/miscellaneous/K-RTheCPL/precedence.png" alt="precedence"></p>
<h1 id="CH3-Control-Flow"><a href="#CH3-Control-Flow" class="headerlink" title="CH3 Control Flow"></a>CH3 Control Flow</h1><h4 id="Loops"><a href="#Loops" class="headerlink" title="Loops"></a>Loops</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( expr1 ; expr2 ; expr3)&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// if expr2 is omitted, it serves like a true, the loop will be infinity</span></span><br></pre></td></tr></table></figure>
<h4 id="Comma"><a href="#Comma" class="headerlink" title="Comma"></a>Comma</h4><p>A pair of expressions separated by a comma is evaluated left to right, and the type and value of the result are the type and value of the right operand.</p>
<p>The commas that separate function arguments, variables in declarations, etc., are not comma operators, and do not guarantee left to right evaluation.</p>
<h4 id="Continue"><a href="#Continue" class="headerlink" title="Continue"></a>Continue</h4><p><code>expr3</code> will be executed after <code>continue</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; N ; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (a[i] &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">continue</span> ; <span class="comment">//skip negative and 0</span></span><br><span class="line">    &#125;</span><br><span class="line">    process_positive();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Goto"><a href="#Goto" class="headerlink" title="Goto"></a>Goto</h4><p>Use it rarely, or try to avoid using it at all.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( ... )&#123;</span><br><span class="line">    <span class="keyword">for</span> (...)&#123;</span><br><span class="line">        <span class="keyword">for</span> (...)&#123;</span><br><span class="line">            <span class="keyword">if</span>(error) <span class="keyword">goto</span> handler ;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">handler:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;error\n&quot;</span>);</span><br><span class="line"><span class="comment">// breaking out of two or more loops at once.</span></span><br></pre></td></tr></table></figure>
<h1 id="CH4-Functions-and-Program-Structure"><a href="#CH4-Functions-and-Program-Structure" class="headerlink" title="CH4 Functions and Program Structure"></a>CH4 Functions and Program Structure</h1><p>C does not allow functions to be defined inside other functions(Not like Python), but declaration is OK.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// global declaration, can be used any where</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">global</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mm</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">local</span><span class="params">(<span class="keyword">void</span>)</span></span>; </span><br><span class="line">    <span class="comment">//local declaration, can only be accessed inside the function</span></span><br><span class="line">    <span class="comment">//access it in `mm` will result in a warning</span></span><br><span class="line">    local();</span><br><span class="line">    mm();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mm</span><span class="params">()</span></span>&#123;</span><br><span class="line">    local(); <span class="comment">//[Warning] use of out-of-scope declaration</span></span><br><span class="line">    global();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">local</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;local\n&quot;</span>); &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">global</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;global\n&quot;</span>); &#125;</span><br></pre></td></tr></table></figure>
<h4 id="Static"><a href="#Static" class="headerlink" title="Static"></a>Static</h4><ul>
<li><p><code>static</code> serve as <code>private</code> in C, limit access to the source file contains it.</p>
</li>
<li><p><code>static</code> variable is permanent and private in a function</p>
</li>
</ul>
<h4 id="Register-Variables"><a href="#Register-Variables" class="headerlink" title="Register Variables"></a>Register Variables</h4><blockquote>
<p>A register declaration advises the compiler that the variable in question will be heavily used. The idea is that <strong>register variables are to be placed in machine registers</strong>, which may result in smaller and faster programs. <strong>But compilers are free to ignore the advice.</strong></p>
</blockquote>
<ul>
<li><p>The register declaration can only be applied to automatic variables and to the formal parameters of a function.</p>
</li>
<li><p>it is not possible to take the address of a register variable</p>
</li>
</ul>
<h4 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>An automatic variable declared and initialized in a block is initialized each time the block is entered</p>
</li>
<li><p>hide external variables and functions of the same name.</p>
</li>
<li><p>As a matter of style, it’s best to avoid variable names that conceal names in an outer scope; the potential for confusion and error is too great.</p>
</li>
</ul>
<h4 id="Recursion"><a href="#Recursion" class="headerlink" title="Recursion"></a>Recursion</h4><p><em>A way to print an integer digit by digit other than using an array</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printn</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( n == <span class="number">0</span> ) <span class="keyword">return</span> ; <span class="comment">// recursion base</span></span><br><span class="line">    printn( n / <span class="number">10</span> );    <span class="comment">// print the previous digits</span></span><br><span class="line">    <span class="built_in">putchar</span>( n % <span class="number">10</span> + <span class="string">&#x27;0&#x27;</span>); <span class="comment">// print the last digit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Macro-substitution"><a href="#Macro-substitution" class="headerlink" title="Macro substitution"></a>Macro substitution</h4><p>Substitutions are made <strong>only for tokens</strong>, and do not take place within quoted strings. For example, if <code>YES</code> is a defined name, there would be no substitution in <code>printf(&quot;YES&quot;)</code> or in <code>YESMAN</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swap(a,b) a = a ^ b ;\</span></span><br><span class="line">                  b = a ^ b ;\</span><br><span class="line">                  a = a ^ b</span><br></pre></td></tr></table></figure>
<p>Names may be undefined with #undef, usually to ensure that a routine is really a function, not a macro</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> getchar</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getchar</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>A <strong>parameter name</strong> is preceded by a <code>#</code> in the replacement text, the combination will be expanded into a quoted string with the parameter replaced by the actual argument.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dprint(varname) printf(#varname <span class="meta-string">&quot; = 0x%x\n&quot;</span> , varname)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">23423</span>;</span><br><span class="line">    dprint(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can see the substitution result by preprocess the source file</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -E source.c -o afterpre.c</span><br></pre></td></tr></table></figure>
<p>The preprocessor operator <code>##</code> provides a way to concatenate names during macro expansion.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> paste(front, back) front ## back </span></span><br><span class="line"><span class="comment">// so paste(name, 1) creates the token name1.</span></span><br></pre></td></tr></table></figure>
<h4 id="Conditional-Inclusion"><a href="#Conditional-Inclusion" class="headerlink" title="Conditional Inclusion"></a>Conditional Inclusion</h4><p><em>The <code>#if</code> line evaluates a constant integer expression. If the expression is non-zero, subsequent lines until an <code>#endif</code> or <code>#elif</code> or <code>#else</code> are included.</em></p>
<p>The expression <code>defined(name)</code> in a <code>#if</code> is 1 if the name has been defined, and 0 otherwise.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//check if header has already been included</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !<span class="meta-keyword">define</span>(Flag) <span class="comment">// if not include</span></span></span><br><span class="line">                   <span class="comment">// include it</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;head.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> Flag <span class="comment">// shortcut for define()</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> Flag <span class="comment">// shortcut for !define()</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tests the name SYSTEM to decide which version of a header to include:</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SYSTEM == SYSV</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> HDR <span class="meta-string">&quot;sysv.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> SYSTEM == BSD</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> HDR <span class="meta-string">&quot;bsd.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> SYSTEM == MSDOS</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> HDR <span class="meta-string">&quot;msdos.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> HDR <span class="meta-string">&quot;default.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> HDR</span></span><br></pre></td></tr></table></figure>
<h1 id="CH5-Array-and-Pointer"><a href="#CH5-Array-and-Pointer" class="headerlink" title="CH5 Array and Pointer"></a>CH5 Array and Pointer</h1><p>Any pointer can be cast to <code>void *</code> and back again <strong>without loss of information</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> * p ; <span class="comment">//a generic pointer</span></span><br></pre></td></tr></table></figure>
<p>When an array name is passed to a function, what is passed is the address of the initial element. Within the called function, this argument is a local variable, and so an array name parameter is a pointer, that is, a variable containing an address, which can be changed.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="built_in">array</span> [N] ;</span><br><span class="line"><span class="built_in">array</span>++ <span class="comment">// Invalid !</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">function</span><span class="params">(<span class="keyword">int</span> a [])</span></span>&#123;</span><br><span class="line">    a++ ; <span class="comment">// Valid.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="String-Pointers"><a href="#String-Pointers" class="headerlink" title="String Pointers"></a>String Pointers</h4><p><em>C does not provide any operators for processing an entire string of characters as a unit. It is always an array</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> amessage[] = <span class="string">&quot;now is the time&quot;</span>; <span class="comment">/* an array */</span></span><br><span class="line"><span class="keyword">char</span> *pmessage = <span class="string">&quot;now is the time&quot;</span>; <span class="comment">/* a pointer */</span></span><br><span class="line"></span><br><span class="line">amessage[<span class="number">0</span>] = <span class="string">&#x27;1&#x27;</span> ; <span class="comment">// OK</span></span><br><span class="line">pmessage[<span class="number">0</span>] = <span class="string">&#x27;1&#x27;</span> ; <span class="comment">// Segmentation Fault</span></span><br><span class="line"><span class="comment">/* pmessage is just a pointer, an address, the acutal data</span></span><br><span class="line"><span class="comment">located at .rodata section in the elf, it is read-only */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//strcpy, implementation friendly version</span></span><br><span class="line"><span class="keyword">char</span> * source = ... ;</span><br><span class="line"><span class="keyword">char</span> * destination = ... ;</span><br><span class="line"><span class="keyword">while</span> ( *destination++ = *source++ ) ; <span class="comment">// The C one-liner</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*p++ = val;  <span class="comment">/* push val onto stack */</span></span><br><span class="line">val = *--p;  <span class="comment">/* pop top of stack into val */</span></span><br></pre></td></tr></table></figure>
<p>Want to return a string in a function ?</p>
<p>We can only return pointer, so let’s have some <strong>private and permanent</strong> space</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">duplicate</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * <span class="built_in">string</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> size = <span class="number">1001</span> ;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buffer [size]; <span class="comment">// allocate private space in .data</span></span><br><span class="line">    <span class="keyword">char</span> * head = buffer ;</span><br><span class="line">    <span class="keyword">size_t</span> len = <span class="built_in">strlen</span>(<span class="built_in">string</span>);</span><br><span class="line">    <span class="keyword">if</span> ( len &lt;= <span class="number">1000</span> )&#123;</span><br><span class="line">     <span class="keyword">while</span>( *head++ = *<span class="built_in">string</span>++ );</span><br><span class="line">     <span class="keyword">return</span> buffer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123; <span class="keyword">return</span> <span class="literal">NULL</span> ;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Array-pointer"><a href="#Array-pointer" class="headerlink" title="Array pointer"></a>Array pointer</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> stringarray [<span class="number">10</span>][<span class="number">100</span>] ;</span><br><span class="line"><span class="comment">/* We can also treat it as 10 pointers */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">char</span> [][<span class="number">100</span>])</span></span>; <span class="comment">//Only the first dimension can be omitted</span></span><br><span class="line"><span class="comment">/* Since it is still a pointer, but we have to know how much space it treated as a single unin */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">char</span> (*)[<span class="number">100</span>])</span></span>;</span><br></pre></td></tr></table></figure>
<p>The important advantage of the pointer array(<code>int* pointers [10]</code>) over multi-dimension array(<code>int array[10][20]</code>)is that the rows of the array may be of different lengths(<code>not 20</code>).</p>
<p><img src="/2022/06/17/miscellaneous/K-RTheCPL/vs.png" alt="vs"></p>
<h4 id="Pointers-to-Functions"><a href="#Pointers-to-Functions" class="headerlink" title="Pointers to Functions"></a>Pointers to Functions</h4><blockquote>
<p>In C, a function itself is not a variable, but it is possible to define pointers to functions, which<br>can be assigned, placed in arrays, passed to functions, returned by functions, and so on.</p>
<p>(Since it is just the entry address of a section of code!)</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> * a , <span class="keyword">int</span> * b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp = *a ;</span><br><span class="line">    *a = *b ;</span><br><span class="line">    *b = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The address of function swap is %p\n&quot;</span> , swap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">KR  % ./a.out</span></span><br><span class="line"><span class="comment">The address of function swap is 0x10d99cf10</span></span><br><span class="line"><span class="comment">KR  % ./a.out</span></span><br><span class="line"><span class="comment">The address of function swap is 0x1032e8f10</span></span><br><span class="line"><span class="comment">KR  % ./a.out</span></span><br><span class="line"><span class="comment">The address of function swap is 0x101502f10</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>You can use it just like an array name</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Define</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  pattern <span class="meta-string">&quot;Test passed&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(pattern <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(pattern);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">walk</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> * walk = pattern ;</span><br><span class="line">    <span class="keyword">while</span>(*walk)&#123; <span class="built_in">putchar</span>(*walk++); &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> (*farray[<span class="number">3</span>])(<span class="keyword">void</span>) = &#123;echo , put , walk&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i&lt;<span class="number">3</span> ;i++)&#123;</span><br><span class="line">        farray[i]();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (*fp)(<span class="keyword">void</span>); <span class="comment">// fp is a pointer, pointing to a function</span></span><br><span class="line"></span><br><span class="line">name[N] <span class="comment">// name is an array of N elements</span></span><br><span class="line"><span class="keyword">void</span> (*name[N])(<span class="keyword">void</span>) <span class="comment">//name is an array of N elements</span></span><br><span class="line"><span class="comment">//element is a pointer points to function whose prototype is void f(void)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//used in sorting function</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">compare</span><span class="params">(<span class="keyword">int</span> a , <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a &lt; b ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">bool</span> (*cmp)(<span class="keyword">int</span> a , <span class="keyword">int</span> b))</span></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> res = (*cmp)(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span> , res);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    sort(compare);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="How-to-read-a-C-declaration"><a href="#How-to-read-a-C-declaration" class="headerlink" title="How to read a C declaration ?"></a>How to read a C declaration ?</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//recall operator precedence</span></span><br><span class="line">    ()          &gt;          []         &gt;     *</span><br><span class="line">left to right        left to right         right to left</span><br><span class="line"><span class="comment">//the rule</span></span><br><span class="line">from inside to outside</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> (*(*x())[])() ;</span><br><span class="line"><span class="number">1.</span> x() <span class="comment">// x is a function</span></span><br><span class="line"><span class="number">2.</span> *x() <span class="comment">// x is a function returning a pointer</span></span><br><span class="line"><span class="number">3.</span> (*x())[] <span class="comment">// x is a function returning a pointer points an array</span></span><br><span class="line"><span class="number">4.</span> (*(*x())[]) <span class="comment">// x is a function returning a pointer points an array whose element is pointer</span></span><br><span class="line"><span class="number">5.</span> (*(*x())[])() <span class="comment">//  x is a function returning a pointer points an array whose element is pointer pointing a function</span></span><br><span class="line"><span class="number">6.</span> <span class="keyword">char</span> (*(*x())[])() <span class="comment">// x is a function returning a pointer points an array whose element is pointer pointing a function whose return type is char</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> (*(*x[<span class="number">3</span>])())[<span class="number">5</span>] ;</span><br><span class="line"><span class="comment">//x: array[3] of pointer to function returning pointer to array[5] of char</span></span><br></pre></td></tr></table></figure>
<p>The book also provide a ‘recursion descend’ program to understand the declaration.</p>
<h1 id="CH6-Structure"><a href="#CH6-Structure" class="headerlink" title="CH6 Structure"></a>CH6 Structure</h1><p><em>A structure is a collection of one or more variables, possibly of different types, grouped together under a single name for convenient handling.</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//struct name is optional</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span> ... &#125; x, y, z;</span><br><span class="line"></span><br><span class="line"><span class="comment">// is syntactically analogous to</span></span><br><span class="line"><span class="keyword">int</span> x, y, z;</span><br><span class="line"></span><br><span class="line"><span class="comment">//it is handy to use combined with typedef</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> x ;</span><br><span class="line">    <span class="keyword">int</span> y ;</span><br><span class="line">&#125;Point;</span><br></pre></td></tr></table></figure>
<p>Structures can be copied as a whole entity, passing to or returning by a function.</p>
<blockquote>
<p>In <code>x86_64</code> architecture, according to my observation, big <code>struct</code> is passing and returning via using stack space, <code>rax or rdx</code> serve as the pointer pointing to returned space</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">point</span> &#123;</span> <span class="keyword">long</span> x ; <span class="keyword">long</span> y,z,p,q,m,n ;&#125;  ;</span><br><span class="line"><span class="function">struct point <span class="title">init</span><span class="params">(<span class="keyword">long</span> <span class="keyword">int</span> x, <span class="keyword">long</span> <span class="keyword">int</span> y,<span class="keyword">long</span> <span class="keyword">int</span> z,<span class="keyword">long</span> <span class="keyword">int</span> p,<span class="keyword">long</span> <span class="keyword">int</span> q,<span class="keyword">long</span> <span class="keyword">int</span> m,<span class="keyword">long</span> <span class="keyword">int</span> n )</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">point</span> <span class="title">res</span> ;</span></span><br><span class="line">    res.x = x ;</span><br><span class="line">    res.y = y ;</span><br><span class="line">    res.z = z ;</span><br><span class="line">    res.p = p ;</span><br><span class="line">    res.q = q ;</span><br><span class="line">    res.m = m ;</span><br><span class="line">    res.n = n ;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">point</span> <span class="title">p</span> ;</span></span><br><span class="line">    p = init(<span class="number">0xcccc</span>,<span class="number">0xcccc</span>,<span class="number">0xbbbb</span>,<span class="number">0xbbbb</span>,<span class="number">0xbbbb</span>,<span class="number">0xffffffff</span>,<span class="number">0xffffffff</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We all know that <code>struct</code> will be padding if they are not aligned. How can we tell the exact size ? We use <code>sizeof</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> a ;</span><br><span class="line">    <span class="keyword">int</span> b ;</span><br><span class="line">&#125; var ;</span><br><span class="line"><span class="keyword">sizeof</span>(var);</span><br></pre></td></tr></table></figure>
<p>Structures are useful when implementing hash table, since pair structure is natural for it.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* simple hash table */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">entry</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> * key ;</span><br><span class="line">    <span class="keyword">char</span> * value ;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">entry</span> * <span class="title">next</span> ;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE 100</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">entry</span> * <span class="title">table</span> [<span class="title">SIZE</span>] ;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">hash</span><span class="params">(<span class="keyword">char</span> * <span class="built_in">string</span>)</span></span>&#123;</span><br><span class="line">    srand(<span class="number">99</span>);</span><br><span class="line">    <span class="keyword">size_t</span> hashvalue = (<span class="keyword">size_t</span>)rand();</span><br><span class="line">    <span class="keyword">while</span>(*<span class="built_in">string</span>)&#123; hashvalue+=*<span class="built_in">string</span>++; &#125;</span><br><span class="line">    <span class="keyword">return</span> hashvalue % SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">install</span><span class="params">(<span class="keyword">char</span> * k , <span class="keyword">char</span> * v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> index = hash(k);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">entry</span> * <span class="title">newentry</span> =</span> (struct entry*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct entry));</span><br><span class="line">    <span class="keyword">if</span> (newentry == <span class="literal">NULL</span> ) <span class="keyword">return</span>  <span class="literal">false</span> ;</span><br><span class="line">    newentry-&gt;key = k ;</span><br><span class="line">    newentry-&gt;value = v ;</span><br><span class="line">    newentry-&gt;next = <span class="literal">NULL</span> ;</span><br><span class="line">    <span class="keyword">if</span>(table[index] == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        table[index] = newentry ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        struct entry * walk = table[index];</span><br><span class="line">        <span class="keyword">for</span>(; walk-&gt;next ; walk=walk-&gt;next);</span><br><span class="line">        walk-&gt;next = newentry ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> * <span class="title">fetch</span><span class="params">(<span class="keyword">char</span> * key)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> index = hash(key);</span><br><span class="line">    <span class="keyword">if</span>(table[index] == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, table[index]-&gt;key) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> table[index]-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            struct entry * walk = table[index]-&gt;next;</span><br><span class="line">            <span class="keyword">while</span>(walk)&#123;</span><br><span class="line">               <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, walk-&gt;key) == <span class="number">0</span>)&#123;</span><br><span class="line">                   <span class="keyword">return</span> walk-&gt;value;</span><br><span class="line">               &#125;</span><br><span class="line">               walk = walk-&gt;next ;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    install(<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;World&quot;</span>);</span><br><span class="line">    install(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">    install(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Jack&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello : %s\n&quot;</span> , fetch(<span class="string">&quot;Hello&quot;</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1 : %s\n&quot;</span> , fetch(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;name : %s\n&quot;</span> , fetch(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="Mimic-class-via-combining-struct-and-function-pointer"><a href="#Mimic-class-via-combining-struct-and-function-pointer" class="headerlink" title="Mimic class via combining struct and function pointer"></a>Mimic <code>class</code> via combining <code>struct</code> and <code>function pointer</code></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span>  <span class="class"><span class="keyword">struct</span> <span class="title">person</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> age ;</span><br><span class="line">    <span class="keyword">char</span> * name ;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">person</span> * <span class="title">this</span> ;</span></span><br><span class="line">    <span class="keyword">void</span> (*show)(struct person *) ;</span><br><span class="line">&#125;Person;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(struct person* <span class="keyword">this</span> )</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;age : %d name : %s\n&quot;</span> , <span class="keyword">this</span>-&gt;age , <span class="keyword">this</span>-&gt;name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> Person * <span class="title">newPerson</span><span class="params">(<span class="keyword">int</span> a , <span class="keyword">char</span> * n)</span></span>&#123;</span><br><span class="line">    Person * <span class="keyword">this</span> = (Person*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Person));</span><br><span class="line">    <span class="keyword">this</span>-&gt;age = a ;</span><br><span class="line">    <span class="keyword">this</span>-&gt;name = n ;</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="keyword">this</span> = <span class="keyword">this</span> ;</span><br><span class="line">    <span class="keyword">this</span>-&gt;show = show ;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">this</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Person * p = newPerson(<span class="number">22</span>, <span class="string">&quot;Jack&quot;</span>);</span><br><span class="line">    p-&gt;show(p-&gt;<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Union"><a href="#Union" class="headerlink" title="Union"></a>Union</h4><p><em>In effect, a union is a structure in which all members have offset zero from the base, the structure is big enough to hold the ``widest’’ member, and the alignment is appropriate for all<br>of the types in the union.</em></p>
<p><strong>As a result, the syntax is almost the same</strong></p>
<ul>
<li><p>A union may only be initialized with a value of the type of its first member</p>
</li>
<li><p>a union can be used to force a variable to be<br>aligned on a particular kind of storage boundary</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span>  <span class="class"><span class="keyword">union</span> <span class="title">u</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> integer ;</span><br><span class="line">    <span class="keyword">char</span> three [<span class="number">3</span>] ;</span><br><span class="line">&#125;U; <span class="comment">//force three to be aligned to 4 bytes</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span> , <span class="keyword">sizeof</span>(U)) ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* output */</span></span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure>
<h4 id="Bit-fields"><a href="#Bit-fields" class="headerlink" title="Bit-fields"></a>Bit-fields</h4><p><strong><em>Alternative to bitwise operation</em></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> is_keyword : <span class="number">1</span>;</span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> is_extern  : <span class="number">1</span>;</span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> is_static  : <span class="number">1</span>;</span><br><span class="line">&#125; flags;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>This defines a variable table called flags that contains three 1-bit fields</p>
</li>
<li><p>The number following the colon represents the field width in bits.</p>
</li>
<li><p>The fields are declared unsigned int to ensure that they are unsigned quantities.</p>
</li>
<li><p>Almost everything about fields is implementation-dependent.</p>
</li>
<li><p>They are not arrays and they do not have addresses, so the <code>&amp;</code> operator cannot be applied on them.</p>
</li>
<li><p>Fields may be declared only as ints; for portability, specify signed or unsigned explicitly</p>
</li>
</ul>
<h1 id="CH-7-Input-and-Output"><a href="#CH-7-Input-and-Output" class="headerlink" title="CH 7 Input and Output"></a>CH 7 Input and Output</h1><h4 id="printf"><a href="#printf" class="headerlink" title="printf"></a>printf</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">:%s:          :hello, world:</span><br><span class="line">:%<span class="number">10</span>s:        :hello, world:</span><br><span class="line">:%<span class="number">.10</span>s:       :hello, wor:</span><br><span class="line">:%<span class="number">-10</span>s:       :hello, world:</span><br><span class="line">:%<span class="number">.15</span>s:       :hello, world:</span><br><span class="line">:%<span class="number">-15</span>s:       :hello, world   :</span><br><span class="line">:%<span class="number">15.10</span>s:     :     hello, wor:</span><br><span class="line">:%<span class="number">-15.10</span>s:    :hello, wor     :</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> %<span class="number">10</span>s means print at least <span class="number">10</span> characters</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> %<span class="number">.10</span>s means print at most <span class="number">10</span> characters</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%.*s&quot;</span> , maxlen , <span class="built_in">string</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> %<span class="number">-10</span>s means adjust s to left</span><br></pre></td></tr></table></figure>
<h4 id="Variable-length-Argument-Lists"><a href="#Variable-length-Argument-Lists" class="headerlink" title="Variable-length Argument Lists"></a>Variable-length Argument Lists</h4><p>the declaration <code>...</code> means that the number and types of these arguments may vary. The declaration <code>...</code> can only appear at the end of an argument list.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myprintf</span><span class="params">(<span class="keyword">char</span> * fmt , ...)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>The standard header <code>&lt;stdarg.h&gt;</code> contains a set of macro definitions that define how to step through an argument list.</li>
</ul>
<ol>
<li><p>The type <code>va_list</code> is used to declare a variable that will refer to each argument in turn;</p>
</li>
<li><p>The macro <code>va_start</code> initializes <code>va_list</code> to point to the first unnamed argument. It must be called once before <code>va_list</code> is used. There must be <strong>at least one named argument (<code>fmt</code>)</strong></p>
</li>
<li><p>Each call of <code>va_arg</code> returns one argument and steps <code>va_list</code> to the next; <code>va_arg</code> uses a type name<br>to determine what type to return and how big a step to take.</p>
</li>
<li><p>Finally, <code>va_end</code> does whatever cleanup is necessary. It must be called before the program returns</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//print n numbers</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myprintf</span><span class="params">(<span class="keyword">char</span> * fmt , ...)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n ;</span><br><span class="line">    <span class="keyword">int</span> number ;</span><br><span class="line">    <span class="built_in">sscanf</span>(fmt, <span class="string">&quot;%d&quot;</span> ,&amp;n );</span><br><span class="line">    va_list walk ; <span class="comment">// pointer</span></span><br><span class="line">    va_start(walk, fmt); <span class="comment">// point to the first unnamed argument after fmt</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n ; i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> number = va_arg(walk, <span class="keyword">int</span>); <span class="comment">// dereference the pointer as int and point to next anonymous arg, moving the pointer sizeof(int) bytes forward</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span> , number);</span><br><span class="line">    &#125;</span><br><span class="line">    va_end(walk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    myprintf(<span class="string">&quot;3&quot;</span> , <span class="number">999</span> , <span class="number">666</span> , <span class="number">777</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>printf</code> in <code>stdio</code> has a similar logic here, and the printing loop is not controlled by <code>n</code> but by the format string <code>fmt</code></p>
</blockquote>
<p>So we can have the <strong>format string exploit</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> target ;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> * argv [])</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Target : %p\n&quot;</span>  , &amp;target);</span><br><span class="line">    <span class="keyword">char</span> buf [<span class="number">1000</span>] ;</span><br><span class="line">    <span class="keyword">char</span> c ;</span><br><span class="line">    <span class="keyword">char</span> * walk = buf ;</span><br><span class="line">    <span class="keyword">while</span>( ( c = getchar() ) != EOF ) &#123;</span><br><span class="line">        *walk = c ;</span><br><span class="line">        walk++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(buf); <span class="comment">// format string exploit</span></span><br><span class="line">    <span class="keyword">if</span> ( target ) <span class="built_in">puts</span>(<span class="string">&quot;!!!!!!!!!!!!!!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// You may want to turn off Linux ASLR first</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">target = <span class="number">0x555555558044</span></span><br><span class="line">btarget = target.to_bytes(<span class="number">8</span>,<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.stdout.buffer.write(<span class="string">b&#x27;&#123;%p&#125;&#x27;</span>*<span class="number">18</span>)</span><br><span class="line">sys.stdout.buffer.write(<span class="string">b&#x27;&#123;%p&#125;&#x27;</span>)</span><br><span class="line">sys.stdout.buffer.write(<span class="string">b&#x27;&#123;%n&#125;&#x27;</span>)</span><br><span class="line">sys.stdout.buffer.write(<span class="string">b&#x27;A&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">sys.stdout.buffer.write(btarget)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// printf.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libioP.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> printf</span></span><br><span class="line"><span class="comment">/* Write formatted output to stdout from the format string FORMAT.  */</span></span><br><span class="line"><span class="comment">/* VARARGS1 */</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">__printf (<span class="keyword">const</span> <span class="keyword">char</span> *format, ...)</span><br><span class="line">&#123;</span><br><span class="line">  va_list arg;</span><br><span class="line">  <span class="keyword">int</span> done;</span><br><span class="line">  va_start (arg, format);</span><br><span class="line">  done = __vfprintf_internal (<span class="built_in">stdout</span>, format, arg, <span class="number">0</span>);</span><br><span class="line">  va_end (arg);</span><br><span class="line">  <span class="keyword">return</span> done;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> _IO_printf</span></span><br><span class="line">ldbl_strong_alias (__printf, <span class="built_in">printf</span>);</span><br><span class="line">ldbl_strong_alias (__printf, _IO_printf);</span><br></pre></td></tr></table></figure>
<p>Then in <code>__vfprintf_internal</code> there are thousands lines of code, and there is a function called <code>__find_specwc</code> to find the first “argument” to print, so just don’t dig in too deep.</p>
<p>By the way, if you want to know <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/49733154/how-is-builtin-va-list-implemented">How is “__builtin_va_list” implemented?</a>, you may need to study the source code of your compiler rather than C stdlibs.</p>
<h4 id="File"><a href="#File" class="headerlink" title="File"></a>File</h4><p>When a C program is started, the operating system environment is responsible for opening three files(<code>stdin,stdout,stderr</code>) and providing pointers for them.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getchar and putchar can be defined in terms of getc, putc, stdin, and stdout as follows:</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> getchar()    getc(stdin)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> putchar(c)   putc((c), stdout)</span></span><br></pre></td></tr></table></figure>
<h1 id="CH8-The-UNIX-System-Interface"><a href="#CH8-The-UNIX-System-Interface" class="headerlink" title="CH8 The UNIX System Interface"></a>CH8 The UNIX System Interface</h1><p>A directory is a file that contains a list of filenames and some indication of where they are located. The “location’’ is an index into another table called the <code>inode</code> list. The <code>inode</code> for a file is where all information about the file except its name is kept. A directory entry generally consists of only two items, the <strong>filename and an <code>inode</code> number</strong>.</p>
<blockquote>
<p>The whole point with “everything is a file” is not that you have some random filename (indeed, sockets and pipes show that “file” and “filename” have nothing to do with each other), but the fact that <strong>you can use common tools to operate on different things.</strong></p>
<p>By  <a target="_blank" rel="noopener" href="https://yarchive.net/comp/linux/everything_is_file.html">Linus Torvalds</a></p>
</blockquote>
<h2 id="Is-directory-and-regular-file-the-same"><a href="#Is-directory-and-regular-file-the-same" class="headerlink" title="Is directory and regular file the same?"></a>Is directory and regular file the same?</h2><p><em>The answer is : Yes, but also NO</em></p>
<p><strong>How files are organized is highly depend on the file system, and there are tons of file system</strong></p>
<p>Let’s take <code>EXT2</code> as an example here</p>
<h4 id="How-they-can-be-the-same"><a href="#How-they-can-be-the-same" class="headerlink" title="How they can be the same?"></a>How they can be the same?</h4><p>They are both byte stream.</p>
<p><img src="/2022/06/17/miscellaneous/K-RTheCPL/theyaresame.png" alt="same"></p>
<p>We have a directory organization like this in <code>ext2</code> file system</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># left side</span><br><span class="line">.</span><br><span class="line">|-- file1</span><br><span class="line">|-- lost+found</span><br><span class="line">&#96;-- mydir</span><br><span class="line">    |-- file2</span><br><span class="line">    |-- file3</span><br><span class="line">    &#96;-- newdir</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># right side</span><br><span class="line">.</span><br><span class="line">|-- file1</span><br><span class="line">|-- lost+found</span><br><span class="line">&#96;-- mydir</span><br><span class="line">    |-- file2</span><br><span class="line">    |-- file3</span><br><span class="line">    &#96;-- file4</span><br></pre></td></tr></table></figure>
<p>We can see that:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>getcontent(file4)</span><br><span class="line">[<span class="number">0x43</span> , <span class="number">0x43</span> , <span class="number">0x43</span> , <span class="number">0x43</span> , <span class="number">0x0a</span>] <span class="comment"># CCCC\n</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>getcontent(newdir)</span><br><span class="line">[<span class="number">0x10</span> , <span class="number">0x00</span> , <span class="number">0x00</span> , <span class="number">0x00</span> , <span class="number">0x0c</span> , <span class="number">0x00</span> , ... , <span class="number">0x2e</span> , <span class="number">0x2e</span>]</span><br></pre></td></tr></table></figure>
<p>Content of regular file can be anything, characters, video data, binary instructions,…</p>
<p>Content of directory have fixed meaning, since they are created by file system, rather than arbitrary data generated by user. In <code>ext2</code>, they are</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="keyword">long</span> inode_number;</span><br><span class="line">    <span class="keyword">int</span> entry_size ;</span><br><span class="line">    <span class="keyword">int</span> name_length ;</span><br><span class="line">    <span class="keyword">char</span> [name_length] filename ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/06/17/miscellaneous/K-RTheCPL/more.png" alt="more"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># left</span><br><span class="line">.</span><br><span class="line">|-- file1</span><br><span class="line">|-- lost+found</span><br><span class="line">&#96;-- mydir</span><br><span class="line">    |-- file2</span><br><span class="line">    |-- file3</span><br><span class="line">    &#96;-- file4</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># right</span><br><span class="line">.</span><br><span class="line">|-- lost+found</span><br></pre></td></tr></table></figure>
<h4 id="How-they-can-be-different"><a href="#How-they-can-be-different" class="headerlink" title="How they can be different ?"></a>How they can be different ?</h4><p>It is nonsense to read the content of a directory as raw bytes and people always want the files in the directory.</p>
<blockquote>
<p>In modern times there are many kinds of filesystems that can be mounted by Linux and other unix-like systems (ext4, ZFS, NTFS!), some of which have complex directory formats. You can’t do anything sensible with the raw bytes of an arbitrary directory. So the kernel has taken on the responsibility of providing a generic interface to directories as abstract objects. <code>readdir</code> is the central piece of that interface.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c ;</span><br><span class="line">    <span class="keyword">int</span> n_read ;</span><br><span class="line">    <span class="keyword">while</span>((n_read = read(fd , &amp;c , <span class="number">1</span>)) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">putchar</span>(c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n_read == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//EOF</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[END]\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//ERROR</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[ERROR] : %s\n&quot;</span> , strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// Reading a regular file</span></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/path/to/file&quot;</span>, O_RDONLY , <span class="number">0</span>);</span><br><span class="line">    show(fd);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="comment">// Reading a directory</span></span><br><span class="line">    fd = open(<span class="string">&quot;/path/to/dir&quot;</span> , O_RDONLY , <span class="number">0</span>);</span><br><span class="line">    show(fd);</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out</span><br><span class="line">HelloAAAA</span><br><span class="line">[END]</span><br><span class="line">[ERROR] : Is a directory</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/17618472/using-read-system-call-on-a-directory">No <code>readdir</code> any more</a></p>
<p>However, we can still operate on the uniform interface provided by the standard library</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FILE * fp = fopen(<span class="string">&quot;/path/to/file&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> line [<span class="number">1000</span>];</span><br><span class="line">    <span class="keyword">while</span>( fgets(line, <span class="number">1000</span>, fp) )&#123; <span class="built_in">puts</span>(line); &#125;</span><br><span class="line"></span><br><span class="line">    DIR * dp = opendir(<span class="string">&quot;/path/to/dir/&quot;</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> * <span class="title">entry</span> ;</span></span><br><span class="line">    <span class="keyword">while</span>( (entry = readdir(dp)) != <span class="literal">NULL</span> )&#123; <span class="built_in">puts</span>(entry-&gt;d_name); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out</span><br><span class="line">HelloAAAA</span><br><span class="line"></span><br><span class="line">..</span><br><span class="line">.</span><br><span class="line">newdir</span><br><span class="line">file2</span><br><span class="line">file3</span><br></pre></td></tr></table></figure>
<h4 id="More-about-file-system-on-Linux-ext2-as-example"><a href="#More-about-file-system-on-Linux-ext2-as-example" class="headerlink" title="More about file system on Linux (ext2 as example)"></a>More about file system on Linux (<code>ext2</code> as example)</h4><p>According to <a target="_blank" rel="noopener" href="https://tldp.org/LDP/tlk/fs/filesystem.html">Linux documentation project, file system</a></p>
<ul>
<li><p>We can hide files in a directory by mounting a file system at the directory, the files will be recovered after umounting.</p>
</li>
<li><p>The real file systems were separated from the operating system and system services by an interface layer known as the Virtual File system, or VFS.</p>
<p>All of the details of the Linux file systems are translated by software so that all file systems appear identical to the rest of the Linux kernel and to programs running in the system. Linux’s Virtual File system layer allows you to transparently mount the many different file systems at the same time.</p>
<img src="http://e2fsprogs.sourceforge.net/ext2-vfs.gif" title="" alt="" data-align="center">
</li>
<li><p>Physical Layout of the EXT2 File system</p>
<img src="http://www.porcupine.org/forensics/forensic-discovery/figure3.3.gif" title="" alt="UNIX FS layout" data-align="center">

<img src="https://tldp.org/LDP/tlk/fs/ext2.gif" title="" alt="" data-align="center">
</li>
<li><p>In the EXT2 file system, the <code>inode</code> is the basic building block; every file and directory in the file system is described by one and only one <code>inode</code>.<code>Inode</code> structure</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Inode</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.mode</span><br><span class="line">        self.ownerInfo</span><br><span class="line">        self.size</span><br><span class="line">        self.timestamps</span><br><span class="line">        self.datablocks</span><br></pre></td></tr></table></figure>

<p><img src="https://tldp.org/LDP/tlk/fs/ext2_inode.gif"></p>
</li>
<li><p>Super block</p>
<p>The Super block contains a <strong>description of the basic size and shape of this file system.</strong> The information within it allows the file system manager to use and maintain the file system. Usually only the Super block in Block Group 0 is read when the file system is mounted but each Block Group contains a duplicate copy in case of file system corruption.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">$ apt install sleuthkit</span><br><span class="line">$ fsstat file_s.img</span><br><span class="line">FILE SYSTEM INFORMATION</span><br><span class="line">--------------------------------------------</span><br><span class="line">File System Type: Ext2</span><br><span class="line">Volume Name:</span><br><span class="line">Volume ID: bf800aaad8ff14851b4bf9289b25ea9d</span><br><span class="line"></span><br><span class="line">Last Written at: 2022-06-29 02:28:03 (EDT)</span><br><span class="line">Last Checked at: 2022-06-29 00:43:35 (EDT)</span><br><span class="line"></span><br><span class="line">Last Mounted at: 2022-06-29 02:28:03 (EDT)</span><br><span class="line">Unmounted Improperly</span><br><span class="line">Last mounted on: /root/.cache/<span class="built_in">test</span>/mountpoint</span><br><span class="line"></span><br><span class="line">Source OS: Linux</span><br><span class="line">Dynamic Structure</span><br><span class="line">Compat Features: Ext Attributes, Resize Inode, Dir Index</span><br><span class="line">InCompat Features: Filetype,</span><br><span class="line">Read Only Compat Features: Sparse Super, Large File,</span><br><span class="line"></span><br><span class="line">METADATA INFORMATION</span><br><span class="line">--------------------------------------------</span><br><span class="line">Inode Range: 1 - 17</span><br><span class="line">Root Directory: 2</span><br><span class="line">Free Inodes: 0</span><br><span class="line"></span><br><span class="line">CONTENT INFORMATION</span><br><span class="line">--------------------------------------------</span><br><span class="line">Block Range: 0 - 99</span><br><span class="line">Block Size: 1024</span><br><span class="line">Reserved Blocks Before Block Groups: 1</span><br><span class="line">Free Blocks: 75</span><br><span class="line"></span><br><span class="line">BLOCK GROUP INFORMATION</span><br><span class="line">--------------------------------------------</span><br><span class="line">Number of Block Groups: 1</span><br><span class="line">Inodes per group: 16</span><br><span class="line">Blocks per group: 8192</span><br><span class="line"></span><br><span class="line">Group: 0:</span><br><span class="line">  Inode Range: 1 - 16</span><br><span class="line">  Block Range: 1 - 99</span><br><span class="line">  Layout:</span><br><span class="line">    Super Block: 1 - 1</span><br><span class="line">    Group Descriptor Table: 2 - 2</span><br><span class="line">    Data bitmap: 3 - 3</span><br><span class="line">    Inode bitmap: 4 - 4</span><br><span class="line">    Inode Table: 5 - 6</span><br><span class="line">    Data Blocks: 7 - 99</span><br><span class="line">  Free Inodes: 0 (0%)</span><br><span class="line">  Free Blocks: 75 (75%)</span><br><span class="line">  Total Directories: 4</span><br></pre></td></tr></table></figure></li>
<li><p>Finding a file in <code>ext2</code></p>
<ol>
<li><p>The first <code>inode</code> we need is the <code>inode</code> for the root of the file system and we find its number in the file system’s super block. (To read an <code>EXT2 inode</code> we must look for it in the <code>inode</code> table of the appropriate Block Group)</p>
</li>
<li><p>use this <code>inode</code> to find the data block which hold subdirectories’ names and <code>inode</code> numbers</p>
</li>
<li><p>use subdirectory’s <code>inode</code> number to find the data block where the file’s name and <code>inode</code> is holden.</p>
</li>
<li><p>use  <code>inode</code> of the file to find the actual data block</p>
</li>
</ol>
</li>
<li><p>the VFS describes the system’s files in terms of super blocks and <code>inodes</code> in <strong>much the same way</strong> as the EXT2 file system uses super blocks and <code>inodes</code>.</p>
</li>
<li><p>How it related to <code>file descriptor</code></p>
<p><img src="https://practice.geeksforgeeks.org/ckeditor/images/uploads/1493710190_10-34.jpg"></p>
</li>
</ul>
<p>As a conclusion, I think <strong>file system is just <code>like</code> device driver</strong></p>
<h5 id="Read-more"><a href="#Read-more" class="headerlink" title="Read more"></a>Read more</h5><p><a target="_blank" rel="noopener" href="https://classpage.dmorgan.us/cs40/analyze-ext2.htm">analysis file system</a></p>
<p><a target="_blank" rel="noopener" href="http://www.porcupine.org/forensics/forensic-discovery/chapter3.html#figure3.2">forensics</a></p>
<p><a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1073802/what-are-directories-if-everything-on-linux-is-a-file">Good question</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cyberciti.biz/tips/linux-ext3-ext4-deleted-files-recovery-howto.html">use <code>debugfs</code> to recover deleted file</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=6KjMlm8hhFA&t=297s"><code>inode</code> related problem</a></p>
<p><a target="_blank" rel="noopener" href="https://superuser.com/questions/1160927/where-does-metadata-go-when-you-save-a-file">copy <code>inode</code> metadata with <code>cp -a</code></a></p>
<p><a target="_blank" rel="noopener" href="https://superuser.com/questions/792142/doesnt-metadata-occupy-any-size">file system do not use <code>inode</code></a></p>
<h5 id="Do-experiment-yourself"><a href="#Do-experiment-yourself" class="headerlink" title="Do experiment yourself"></a>Do experiment yourself</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir mountpoint</span><br><span class="line">dd if=/dev/zero of=file_s.img bs=50k count=2</span><br><span class="line">mkfs.ext2 file_s.img</span><br><span class="line">cp file_s.img file_s_orig.img</span><br><span class="line">mount -o loop file_s.img  mountpoint</span><br><span class="line"><span class="meta">#</span><span class="bash"> make change <span class="keyword">in</span> the mounted fs</span></span><br><span class="line">df -l # find the mounted name</span><br><span class="line">umount /dev/loop0</span><br><span class="line">xxd file_s.img &gt; after</span><br><span class="line">xxd file_s_orig.img &gt; before</span><br><span class="line">vimdiff after before</span><br></pre></td></tr></table></figure>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://rubbish-and-world.github.io/2022/06/17/miscellaneous/K-RTheCPL/" data-id="clz8bo3xh006z1uyq2vliaxf6" data-title="K&amp;RTheCPL" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/06/26/miscellaneous/ExtendGDBviaPy/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          ExtendGDBviaPy
        
      </div>
    </a>
  
  
    <a href="/2022/06/11/feelings/Origin/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Origin</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Cryptography/">Cryptography</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Structure/">Data Structure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Electronics/">Electronics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FrontEnd/">FrontEnd</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/FrontEnd/course/">course</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/IOT/">IOT</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LLL/">LLL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/">Machine Learning</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/NTU/">NTU</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/Stanford-CS229/">Stanford CS229</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Math/Discrete-Mathematics/">Discrete Mathematics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/Linear-Algebra/">Linear Algebra</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/Statistics/">Statistics</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Missing-Semester/">Missing Semester</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Networking/">Networking</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Networking/Stanford-CS144/">Stanford CS144</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/OS/30DayOS/">30DayOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/TEP/">TEP</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python-OG/">Python OG</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web3/">Web3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/academic/">academic</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bis/">bis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/csapp/">csapp</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/feeling/">feeling</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/feelings/">feelings</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/misc/">misc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/noval/">noval</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/game/" rel="tag">game</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/game/" style="font-size: 10px;">game</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/09/19/Web3/Blockchain/Solana-Data-Model/">Solana-Data-Model</a>
          </li>
        
          <li>
            <a href="/2024/09/16/feelings/missing-out/">missing-out</a>
          </li>
        
          <li>
            <a href="/2024/09/16/Network/NAT-P2P/">NAT_P2P</a>
          </li>
        
          <li>
            <a href="/2024/09/04/feelings/Ultimate/">Ultimate</a>
          </li>
        
          <li>
            <a href="/2024/08/16/feelings/Nonce/">Nonce</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 rubbish<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>