<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>OSdevSetup | rubbishbin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Develop simple OS on linux">
<meta property="og:type" content="article">
<meta property="og:title" content="OSdevSetup">
<meta property="og:url" content="http://rubbish-and-world.github.io/2022/02/14/miscellaneous/OSdevSetup/index.html">
<meta property="og:site_name" content="rubbishbin">
<meta property="og:description" content="Develop simple OS on linux">
<meta property="og:locale">
<meta property="article:published_time" content="2022-02-14T13:06:30.000Z">
<meta property="article:modified_time" content="2022-02-14T13:47:37.193Z">
<meta property="article:author" content="rubbish">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="rubbishbin" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">rubbishbin</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://rubbish-and-world.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-miscellaneous/OSdevSetup" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/14/miscellaneous/OSdevSetup/" class="article-date">
  <time class="dt-published" datetime="2022-02-14T13:06:30.000Z" itemprop="datePublished">2022-02-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/misc/">misc</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      OSdevSetup
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Develop-simple-OS-on-linux"><a href="#Develop-simple-OS-on-linux" class="headerlink" title="Develop simple OS on linux"></a>Develop simple OS on linux</h1><a id="more"></a>

<p><em>after days of struggling, I finally figure out a way to do the things told by the book 《30日でできる! OS自作入門》 without author’s highly customized toolchain</em></p>
<h3 id="Referrence"><a href="#Referrence" class="headerlink" title="Referrence"></a>Referrence</h3><p><em>Thanks a lot to those gracious people</em></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cs.bham.ac.uk/~exr/lectures/opsys/10_11/lectures/os-dev.pdf">os-dev.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/playlist?list=PLxN4E629pPnKKqYsNVXpmCza8l0Jb6l8-">how to make a 64 bits OS</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.osdev.org/GCC_Cross-Compiler">gcc cross compile</a></li>
<li><a href="wiki.osdev.org">osdev</a></li>
</ul>
<h3 id="How-to"><a href="#How-to" class="headerlink" title="How to"></a>How to</h3><h4 id="1-You-need-a-floppy-disk-to-store-you-code"><a href="#1-You-need-a-floppy-disk-to-store-you-code" class="headerlink" title="1. You need a floppy disk to store you code"></a>1. You need a floppy disk to store you code</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-img create -f raw floppy.img 4M</span><br></pre></td></tr></table></figure>
<h4 id="2-Write-Initial-Program-Loader-ipl-code-and-make-it-into-a-bootsector"><a href="#2-Write-Initial-Program-Loader-ipl-code-and-make-it-into-a-bootsector" class="headerlink" title="2. Write Initial Program Loader(ipl) code and make it into a bootsector"></a>2. Write Initial Program Loader(ipl) code and make it into a bootsector</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">; ipl.s</span><br><span class="line">[org 0x7c00]</span><br><span class="line"></span><br><span class="line">; ---------------------------------- preparing stage -----------------------</span><br><span class="line"></span><br><span class="line">cli ; enable Qemu hlt, see more at stackoverflow why qemu hlt doesn&#39;t work</span><br><span class="line"></span><br><span class="line">mov [BOOT_DISK], dl ; when loading ipl into 0x7c00, bios will store disk number into dl</span><br><span class="line"></span><br><span class="line">setstack:</span><br><span class="line">	mov bp , 0x7c00</span><br><span class="line">	mov sp , bp       ; stack region 0x7c00~0x0000</span><br><span class="line">			  ; now we can use call and ret instruction</span><br><span class="line"></span><br><span class="line">; ---------------------------------- preparing stage -------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mov di,prompt</span><br><span class="line">call printstring</span><br><span class="line">call readdisk</span><br><span class="line">jmp PROGRAM_SPACE</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">prompt:</span><br><span class="line">	db &#39;hello world!&#39; , 0	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%include &quot;helpfuncs.s&quot;</span><br><span class="line">%include &quot;readdisk.s&quot;</span><br><span class="line">; the %include simply copy the content in</span><br><span class="line">	</span><br><span class="line">times 510 - ($ - $$) db 0</span><br><span class="line">db 0x55</span><br><span class="line">db 0xaa</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">; helpfuncs.s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; string address : di</span><br><span class="line">; return value : None</span><br><span class="line">printstring:</span><br><span class="line">	mov al, [di] ; default ds is 0x0000 , so it&#39;s ok to do this</span><br><span class="line">	cmp al,0</span><br><span class="line">	jz end</span><br><span class="line">	mov ah,0x0e</span><br><span class="line">	int 0x10</span><br><span class="line">	inc di</span><br><span class="line">	jmp printstring</span><br><span class="line">end:</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">; readdisk.s</span><br><span class="line"></span><br><span class="line">BOOT_DISK:</span><br><span class="line">	db 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PROGRAM_SPACE equ 0x7e00	; rest of our floppy will be read into 0x7e00, right after our ipl</span><br><span class="line">SECTOR_NUM equ 4                ; how many sectors we need to read into mem</span><br><span class="line"></span><br><span class="line">; 0xfffff *-------------------*</span><br><span class="line">;         |     unused        |</span><br><span class="line">; 0x8000  *-------------------*</span><br><span class="line">;         |   program_space   |</span><br><span class="line">; 0x7e00  *-------------------* &lt;- cs:ip , go upside</span><br><span class="line">;         |       ipl         |</span><br><span class="line">; 0x7c00  *-------------------* &lt;- sp,bp , go downside</span><br><span class="line">;         |      stack        |</span><br><span class="line">; 0x0000  *-------------------*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">readdisk:</span><br><span class="line">	mov ah, 0x02</span><br><span class="line">	mov bx, PROGRAM_SPACE ; read into memory es:bx, es is default 0, so this ok for us to do this</span><br><span class="line">	mov al, SECTOR_NUM    ; how many sectors do we need to read</span><br><span class="line">	mov dl, [BOOT_DISK]   ; read from the same driver with ipl&#39;s</span><br><span class="line">	mov ch, 0x00 ; cylinder 0</span><br><span class="line">	mov dh , 0x00 ; surface 0</span><br><span class="line">	mov cl , 0x02 ; start reading from the second sector</span><br><span class="line">	int 0x13</span><br><span class="line">	jc error	; if (read fail) error(); else return;</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">	mov  di,errmsg</span><br><span class="line">	call printstring</span><br><span class="line">	hlt</span><br><span class="line"></span><br><span class="line">errmsg:</span><br><span class="line">	db &#39;Disk read failed&#39; , 0</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ nasm -o ipl.bin ipl.s</span><br><span class="line"><span class="comment"># assemble instruction into machine code</span></span><br><span class="line">$ dd <span class="keyword">if</span>=ipl.bin of=floppy.img bs=512 count=1 conv=notrunc</span><br><span class="line"><span class="comment"># install into the first sector</span></span><br></pre></td></tr></table></figure>
<h4 id="3-execute-code-from-second-sector-preparing-for-32-protected-mode"><a href="#3-execute-code-from-second-sector-preparing-for-32-protected-mode" class="headerlink" title="3. execute code from second sector, preparing for 32 protected mode"></a>3. execute code from second sector, preparing for 32 protected mode</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">; setup.s</span><br><span class="line"></span><br><span class="line">[org 0x7e00]</span><br><span class="line"></span><br><span class="line">kernel_main equ 0x8000 ; this should be same with the ld -Ttext parameter</span><br><span class="line">; then load the code into memory 0x8000</span><br><span class="line"></span><br><span class="line">mov di,greet</span><br><span class="line">call printstring</span><br><span class="line"></span><br><span class="line">; change into video mode</span><br><span class="line">mov al,0x13</span><br><span class="line">mov ah,0x00</span><br><span class="line">int 0x10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">jmp enterProtected</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">greet:</span><br><span class="line">	db &#39;In second sector!&#39; , 0</span><br><span class="line"></span><br><span class="line">%include &quot;helpfuncs.s&quot;</span><br><span class="line">%include &quot;gdt.s&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; things to do</span><br><span class="line">; 1. disable interrupt, when switching mode, interrupt shouldn&#39;t be handled</span><br><span class="line">; 2. enable A20gate to obtain larger memory space</span><br><span class="line">; 3. load gdt into gdtr to enable semgmented memory mangagement</span><br><span class="line">; 4. change ControlRegister0 , cr0</span><br><span class="line">; 5. flush the pipeline with a far jmp, clear those half-way-done 16 bits instructions</span><br><span class="line">; 6. change data segment to 32 bit mode seg</span><br><span class="line">enterProtected:</span><br><span class="line">	cli ; 1.</span><br><span class="line">	call enableA20 ; 2.</span><br><span class="line">	lgdt [gdt_discriptor] ; 3.</span><br><span class="line">	call alterCR0  ; 4.</span><br><span class="line">	jmp codeseg:start32 ; 5.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">enableA20:</span><br><span class="line">	in al,0x92</span><br><span class="line">	or al,0x02</span><br><span class="line">	out 0x92 , al</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">alterCR0:</span><br><span class="line">	mov eax,cr0</span><br><span class="line">	or eax,0x0001</span><br><span class="line">	mov cr0,eax</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[bits 32] ; 32 bits code following, protected mode</span><br><span class="line"></span><br><span class="line">start32:</span><br><span class="line">	; 6.</span><br><span class="line">	mov ax,dataseg</span><br><span class="line">	mov ss,ax</span><br><span class="line">	mov ds,ax</span><br><span class="line">	mov es,ax</span><br><span class="line">	mov fs,ax</span><br><span class="line">	mov gs,ax</span><br><span class="line">	call kernel_main</span><br><span class="line">	hlt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">; gdt.s</span><br><span class="line"></span><br><span class="line">;gdt entries are stored in GDT</span><br><span class="line">;GDT is stored in memory</span><br><span class="line">;CPU use gdtr to store the size and address of GDT , the value of gdtr is called gdt discriptor</span><br><span class="line"></span><br><span class="line">;GDT</span><br><span class="line"></span><br><span class="line">;the first segment has to be 0, for some unknown reason</span><br><span class="line">gdt_nullseg:</span><br><span class="line">	dd 0</span><br><span class="line">	dd 0</span><br><span class="line">;the second segment is code segment</span><br><span class="line">gdt_codeseg:</span><br><span class="line">	dw 0xffff ; seg size limit , 20 bits, 16 bits here, 4 bits at the end</span><br><span class="line">	dw 0x0000 ; start address of this seg, 32 bits, 24 bits here, 8 bits at the end</span><br><span class="line">	db 0x00</span><br><span class="line">	db 0b10011010 ; access bits ,8 bits</span><br><span class="line">	db 0b11001111 ; G flag, S flag, 00, 4 bits extended seg size limit</span><br><span class="line">	db 0x00 ; extended seg start address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;the third segment is data segment</span><br><span class="line">gdt_dataseg:</span><br><span class="line">	dw 0xffff </span><br><span class="line">	dw 0x0000 </span><br><span class="line">	db 0x00</span><br><span class="line">	db 0b10010010 </span><br><span class="line">	db 0b11001111 </span><br><span class="line">	db 0x00 </span><br><span class="line"></span><br><span class="line">; https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;16628800&#x2F;code-data-segment-overlapping</span><br><span class="line">	</span><br><span class="line">gdt_end:</span><br><span class="line"></span><br><span class="line">gdt_discriptor:</span><br><span class="line">	dw gdt_end - gdt_nullseg - 1 ; size &#x3D; sizeof (GDT) -1 , 16 bits</span><br><span class="line">	dd gdt_nullseg               ; gdt location, 32 bits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;In protected mode ,the value which is going to be loaded into segment register(ss,ds,...) is the offset in GDT, in other word, an index</span><br><span class="line"></span><br><span class="line">; the offsets</span><br><span class="line">codeseg equ gdt_codeseg - gdt_nullseg</span><br><span class="line">dataseg equ gdt_dataseg - gdt_nullseg</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=setup.bin of=floppy.img bs=512 count=1 conv=notrunc seek=1</span><br></pre></td></tr></table></figure>


<h4 id="4-compile-main-and-link-it-with-assembly-helper-functions"><a href="#4-compile-main-and-link-it-with-assembly-helper-functions" class="headerlink" title="4. compile main and link it with assembly helper functions"></a>4. compile main and link it with assembly helper functions</h4><p><span style="color:red">Beware that this is a <strong>cross compilation</strong> process, DO NOT use your system compiler(<code>gcc</code> for example)</span></p>
<p>how to <a target="_blank" rel="noopener" href="https://wiki.osdev.org/GCC_Cross-Compiler">gcc cross compile</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># build cross compile env</span></span><br><span class="line"> $  sudo apt update</span><br><span class="line"> $  sudo apt install build-essential</span><br><span class="line"> $  sudo apt install bison</span><br><span class="line"> $  sudo apt install flex</span><br><span class="line"> $  sudo apt install libgmp3-dev</span><br><span class="line"> $  sudo apt install libmpc-dev</span><br><span class="line"> $  sudo apt install libmpfr-dev</span><br><span class="line"> $  sudo apt install texinfo</span><br><span class="line"> $  <span class="built_in">cd</span> /tmp/</span><br><span class="line"> $  mkdir src</span><br><span class="line"> $  <span class="built_in">cd</span> src</span><br><span class="line"> $  curl -O http://ftp.gnu.org/gnu/binutils/binutils-2.35.1.tar.gz</span><br><span class="line"> $  tar xzf binutils-2.35.1.tar.gz </span><br><span class="line"> $  <span class="built_in">cd</span> binutils-2.35.1/</span><br><span class="line"> $  mkdir -p <span class="variable">$HOME</span>/opt/cross</span><br><span class="line"> $  <span class="built_in">export</span> PREFIX=<span class="string">&quot;<span class="variable">$HOME</span>/opt/cross&quot;</span></span><br><span class="line"> $  <span class="built_in">export</span> TARGET=i686-elf</span><br><span class="line"> $  <span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PREFIX</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"> $  <span class="built_in">cd</span> ../</span><br><span class="line"> $  mkdir build-binutils</span><br><span class="line"> $  <span class="built_in">cd</span> build-binutils/</span><br><span class="line"> $  ../binutils-2.35.1/configure --target=<span class="variable">$TARGET</span> --prefix=<span class="string">&quot;<span class="variable">$PREFIX</span>&quot;</span> --with-sysroot --disable-nls --disable-werror | tee config.log</span><br><span class="line"> $  make</span><br><span class="line"> $  make install</span><br><span class="line"> $  <span class="built_in">cd</span> /tmp/src</span><br><span class="line"> $  wget https://ftp.gnu.org/gnu/gcc/gcc-10.2.0/gcc-10.2.0.tar.gz</span><br><span class="line"> $  mkdir gcc-build</span><br><span class="line"> $  <span class="built_in">cd</span> gcc-build/</span><br><span class="line"> $  <span class="built_in">which</span> -- <span class="variable">$TARGET</span>-as || <span class="built_in">echo</span> <span class="variable">$TARGET</span>-as is not <span class="keyword">in</span> the PATH</span><br><span class="line"> $  <span class="built_in">cd</span> ..</span><br><span class="line"> $  tar xzf gcc-10.2.0.tar.gz </span><br><span class="line"> $  <span class="built_in">cd</span> gcc-build/</span><br><span class="line"> $  ../gcc-10.2.0/configure --target=<span class="variable">$TARGET</span> --prefix=<span class="string">&quot;<span class="variable">$PREFIX</span>&quot;</span> --disable-nls --enable-languages=c,c++ --without-headers</span><br><span class="line"> $  make all-gcc</span><br><span class="line"> $  make all-target-libgcc</span><br><span class="line"> $  make install-gcc</span><br><span class="line"> $  make install-target-libgcc</span><br><span class="line"> $  <span class="variable">$HOME</span>/opt/cross/bin/<span class="variable">$TARGET</span>-gcc --version</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel.c</span></span><br><span class="line"><span class="keyword">void</span> __spoil(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i ; </span><br><span class="line">	<span class="keyword">for</span> ( i = <span class="number">0xa0000</span> ; i &lt;= <span class="number">0xaffff</span> ; i++ )&#123;</span><br><span class="line">		*((<span class="keyword">char</span>*)i) = <span class="number">14</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	__spoil();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">; asmfunc.s</span><br><span class="line">global __spoil</span><br><span class="line"></span><br><span class="line">__spoil:</span><br><span class="line">	mov edi,0xa0000</span><br><span class="line">next:</span><br><span class="line">	mov [edi], byte 13 </span><br><span class="line">	cmp edi, 0xa0fff</span><br><span class="line">	je return</span><br><span class="line">	inc edi</span><br><span class="line">	jmp next</span><br><span class="line">	</span><br><span class="line">return:</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ i686-elf-gcc -ffreestanding -m32 -c -o kernel.o kernel.c</span><br><span class="line">$ i686-elf-ld -Ttext 0x8000 --oformat binary -o kernel.bin  kernel.o asmfunc.o</span><br></pre></td></tr></table></figure>
<p>You can see that we only need to obtain raw machine code</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$  ndisasm -b 32 kernel.bin</span><br><span class="line">00000000  55                push ebp</span><br><span class="line">00000001  89E5              mov ebp,esp</span><br><span class="line">00000003  83E4F0            and esp,byte -0x10</span><br><span class="line">00000006  83EC10            sub esp,byte +0x10</span><br><span class="line">00000009  C744240C00000A00  mov dword [esp+0xc],0xa0000</span><br><span class="line">00000011  EB0C              jmp short 0x1f</span><br><span class="line">00000013  8B44240C          mov eax,[esp+0xc]</span><br><span class="line">00000017  C6000E            mov byte [eax],0xe</span><br><span class="line">0000001A  8344240C01        add dword [esp+0xc],byte +0x1</span><br><span class="line">0000001F  817C240CFFFF0A00  cmp dword [esp+0xc],0xaffff</span><br><span class="line">00000027  7EEA              jng 0x13</span><br><span class="line">00000029  E812000000        call 0x40</span><br><span class="line">0000002E  90                nop</span><br><span class="line">0000002F  C9                leave</span><br><span class="line">00000030  C3                ret</span><br><span class="line">00000031  6690              xchg ax,ax</span><br><span class="line">00000033  6690              xchg ax,ax</span><br><span class="line">00000035  6690              xchg ax,ax</span><br><span class="line">00000037  6690              xchg ax,ax</span><br><span class="line">00000039  6690              xchg ax,ax</span><br><span class="line">0000003B  6690              xchg ax,ax</span><br><span class="line">0000003D  6690              xchg ax,ax</span><br><span class="line">0000003F  90                nop</span><br><span class="line">00000040  BF00000A00        mov edi,0xa0000</span><br><span class="line">00000045  C6070D            mov byte [edi],0xd</span><br><span class="line">00000048  81FFFF0F0A00      cmp edi,0xa0fff</span><br><span class="line">0000004E  7403              jz 0x53</span><br><span class="line">00000050  47                inc edi</span><br><span class="line">00000051  EBF2              jmp short 0x45</span><br><span class="line">00000053  C3                ret</span><br><span class="line">$ xxd kernel.bin</span><br><span class="line">00000000: 5589 e583 e4f0 83ec 10c7 4424 0c00 000a  U.........D$....</span><br><span class="line">00000010: 00eb 0c8b 4424 0cc6 000e 8344 240c 0181  ....D$.....D$...</span><br><span class="line">00000020: 7c24 0cff ff0a 007e eae8 1200 0000 90c9  |$.....~........</span><br><span class="line">00000030: c366 9066 9066 9066 9066 9066 9066 9090  .f.f.f.f.f.f.f..</span><br><span class="line">00000040: bf00 000a 00c6 070d 81ff ff0f 0a00 7403  ..............t.</span><br><span class="line">00000050: 47eb f2c3                                G...</span><br><span class="line"></span><br><span class="line"><span class="comment"># install to floppy</span></span><br><span class="line">$ dd <span class="keyword">if</span>=kernel.bin of=floppy.img bs=512 count=1 conv=notrunc seek=2</span><br></pre></td></tr></table></figure>
<h4 id="5-tidy-up-things-via-makefile"><a href="#5-tidy-up-things-via-makefile" class="headerlink" title="5. tidy up things via makefile"></a>5. tidy up things via makefile</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">disk=floppy.img</span><br><span class="line"></span><br><span class="line"><span class="section">default: <span class="variable">$(disk)</span> ipl.bin setup.bin kernel.bin</span></span><br><span class="line">	dd if=ipl.bin of=<span class="variable">$(disk)</span> bs=512 count=1 conv=notrunc</span><br><span class="line">	dd if=setup.bin of=<span class="variable">$(disk)</span> bs=512 count=1 conv=notrunc seek=1</span><br><span class="line">	dd if=kernel.bin of=<span class="variable">$(disk)</span> bs=512 count=1 conv=notrunc seek=2</span><br><span class="line"></span><br><span class="line"><span class="variable">$(disk)</span>:</span><br><span class="line">	qemu-img create -f raw <span class="variable">$(disk)</span> 4M</span><br><span class="line"></span><br><span class="line"><span class="section">ipl.bin: ipl.s</span></span><br><span class="line">	nasm -o <span class="variable">$@</span> <span class="variable">$?</span></span><br><span class="line"></span><br><span class="line"><span class="section">setup.bin: setup.s</span></span><br><span class="line">	nasm -o <span class="variable">$@</span> <span class="variable">$?</span></span><br><span class="line"></span><br><span class="line"><span class="section">asmfunc.o: asmfunc.s</span></span><br><span class="line">	nasm -f elf32 -o <span class="variable">$@</span> <span class="variable">$?</span></span><br><span class="line"></span><br><span class="line"><span class="section">kernel.bin: kernel.c asmfunc.o</span></span><br><span class="line">	i686-elf-gcc -ffreestanding -m32 -c -o kernel.o kernel.c</span><br><span class="line">	i686-elf-ld -Ttext 0x8000 --oformat binary -o <span class="variable">$@</span>  kernel.o asmfunc.o</span><br><span class="line"></span><br><span class="line"><span class="section">run:</span></span><br><span class="line">	qemu-system-x86_64 -vga std -drive file=<span class="variable">$(disk)</span>,format=raw,index=0</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -r *.o *.bin *.img</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://rubbish-and-world.github.io/2022/02/14/miscellaneous/OSdevSetup/" data-id="cl1otysu0006fghyqbi3g39tu" data-title="OSdevSetup" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/02/22/Database/Introduction/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          Introduction
        
      </div>
    </a>
  
  
    <a href="/2022/02/14/miscellaneous/HowSystemBoot/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">HowSystemBoot</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Cryptography/">Cryptography</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Structure/">Data Structure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Electronics/">Electronics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LLL/">LLL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/">Machine Learning</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/NTU/">NTU</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/Stanford-CS229/">Stanford CS229</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Math/Discrete-Mathematics/">Discrete Mathematics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/Linear-Algebra/">Linear Algebra</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Missing-Semester/">Missing Semester</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Networking/">Networking</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Networking/Stanford-CS144/">Stanford CS144</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/OS/30DayOS/">30DayOS</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python-OG/">Python OG</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/csapp/">csapp</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/feelings/">feelings</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/misc/">misc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/noval/">noval</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/game/" rel="tag">game</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/game/" style="font-size: 10px;">game</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/07/23/Math/LinearAlgebra/VectorSpace/">VectorSpace</a>
          </li>
        
          <li>
            <a href="/2022/07/23/Math/LinearAlgebra/Transpose/">Transpose</a>
          </li>
        
          <li>
            <a href="/2022/07/08/LoaderLinkerLib/StaticLink/">StaticLink</a>
          </li>
        
          <li>
            <a href="/2022/07/08/LoaderLinkerLib/Introduction/">Introduction</a>
          </li>
        
          <li>
            <a href="/2022/07/03/miscellaneous/MoreAboutC/">MoreAboutC</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 rubbish<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>